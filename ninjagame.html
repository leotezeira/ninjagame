<!DOCTYPE html>

<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üç• Ninja RPG - Estilo Naruto</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-0: #0f1020;
            --bg-1: #1a1a2e;
            --bg-2: #0f3460;
            --panel: rgba(0, 0, 0, 0.72);
            --panel-2: rgba(0, 0, 0, 0.55);
            --stroke: #4a5583;
            --accent: #ff8c00;
            --accent-2: #ff6b00;
            --gold: #ffd700;
            --text: #f0f0f0;
            --muted: rgba(240, 240, 240, 0.75);
            --shadow: rgba(0, 0, 0, 0.45);
        }

        html {
            color-scheme: dark;
            -webkit-text-size-adjust: 100%;
        }

    body {
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background:
            radial-gradient(1200px 600px at 50% -20%, rgba(255, 140, 0, 0.18), transparent 60%),
            radial-gradient(900px 500px at 10% 10%, rgba(52, 152, 219, 0.14), transparent 55%),
            radial-gradient(800px 500px at 90% 20%, rgba(241, 196, 15, 0.08), transparent 55%),
            linear-gradient(135deg, var(--bg-1) 0%, var(--bg-2) 100%);
        color: var(--text);
        min-height: 100vh;
        padding: 14px;
        line-height: 1.45;
        letter-spacing: 0.2px;
        text-rendering: optimizeLegibility;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    ::selection {
        background: rgba(255, 140, 0, 0.35);
    }

    .game-container {
        max-width: 920px;
        margin: 0 auto;
        background: var(--panel);
        border-radius: 16px;
        padding: 22px;
        box-shadow:
            0 18px 60px rgba(0, 0, 0, 0.55),
            0 10px 40px rgba(255, 140, 0, 0.22);
        border: 2px solid rgba(255, 140, 0, 0.65);
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(8px);
    }

    .game-container::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background:
            linear-gradient(180deg, rgba(255, 140, 0, 0.08), transparent 30%),
            radial-gradient(900px 260px at 50% 0%, rgba(255, 140, 0, 0.12), transparent 70%),
            repeating-linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.03) 0px,
                rgba(255, 255, 255, 0.03) 2px,
                transparent 2px,
                transparent 10px
            );
        opacity: 0.85;
    }

    .game-container > * {
        position: relative;
        z-index: 1;
    }

    h1 {
        text-align: center;
        color: var(--accent);
        font-size: 2.35em;
        margin-bottom: 18px;
        text-shadow: 0 0 14px rgba(255, 140, 0, 0.35);
        letter-spacing: 1.5px;
    }

    h2, h3, h4 {
        letter-spacing: 0.4px;
    }

    p {
        color: var(--muted);
    }

    .screen {
        display: none;
    }

    .screen.active {
        display: block;
        animation: fadeIn 0.5s;
    }

    @media (prefers-reduced-motion: reduce) {
        .screen.active {
            animation: none;
        }

        .log-entry {
            animation: none;
        }

        .kekkei-genkai-notification {
            animation: none;
        }
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .clan-select {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    .clan-card {
        background: linear-gradient(135deg, rgba(45, 53, 97, 0.95) 0%, rgba(31, 37, 68, 0.95) 100%);
        border: 2px solid rgba(74, 85, 131, 0.95);
        border-radius: 10px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
        box-shadow: 0 10px 26px rgba(0, 0, 0, 0.35);
    }

    .clan-card:hover {
        transform: scale(1.05);
        border-color: #ff8c00;
        box-shadow: 0 5px 20px rgba(255, 140, 0, 0.4);
    }

    .clan-card:active {
        transform: scale(1.02);
    }

    .clan-card h3 {
        color: #ff8c00;
        margin-bottom: 10px;
        font-size: 1.3em;
    }

    .clan-stats {
        text-align: left;
        margin-top: 10px;
        font-size: 0.85em;
    }

    .stat {
        margin: 3px 0;
        padding: 5px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 5px;
        border: 1px solid rgba(74, 85, 131, 0.35);
    }

    .btn {
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
        color: #fff;
        border: none;
        padding: 12px 25px;
        font-size: 1em;
        font-weight: bold;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        margin: 8px 5px;
        box-shadow:
            0 10px 18px rgba(0, 0, 0, 0.35),
            0 0 0 1px rgba(255, 255, 255, 0.06) inset;
        letter-spacing: 0.3px;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(255, 140, 0, 0.5);
    }

    .btn:active {
        transform: translateY(0);
        filter: brightness(0.98);
    }

    .btn:focus-visible,
    .tab-btn:focus-visible,
    .jutsu-btn:focus-visible,
    .clan-card:focus-visible,
    .mission-card:focus-visible,
    .jutsu-card:focus-visible {
        outline: 3px solid rgba(255, 140, 0, 0.35);
        outline-offset: 2px;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .btn-small {
        padding: 8px 15px;
        font-size: 0.9em;
    }

    .btn-secondary {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    }

    .player-info {
        background: var(--panel-2);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 1px solid rgba(255, 140, 0, 0.55);
        box-shadow: 0 10px 26px rgba(0, 0, 0, 0.35);
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 15px;
    }

    .info-item {
        background: rgba(74, 85, 131, 0.22);
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        border: 1px solid rgba(74, 85, 131, 0.38);
    }

    .health-bar, .chakra-bar {
        width: 100%;
        height: 25px;
        background: #333;
        border-radius: 15px;
        overflow: hidden;
        margin: 8px 0;
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.35) inset;
    }

    .health-fill {
        height: 100%;
        background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
        transition: width 0.5s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.9em;
        text-shadow: 0 1px 0 rgba(0, 0, 0, 0.5);
    }

    .chakra-fill {
        height: 100%;
        background: linear-gradient(90deg, #3498db 0%, #2980b9 100%);
        transition: width 0.5s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.9em;
        text-shadow: 0 1px 0 rgba(0, 0, 0, 0.5);
    }

    .combat-area {
        background: rgba(20, 20, 40, 0.72);
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        border: 1px solid rgba(255, 140, 0, 0.55);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
    }

    .enemy-info {
        background: rgba(139, 0, 0, 0.3);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 1px solid rgba(139, 0, 0, 0.85);
    }

    .combat-log {
        background: rgba(0, 0, 0, 0.6);
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        max-height: 250px;
        overflow-y: auto;
        border: 1px solid #4a5583;
        font-size: 0.9em;
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.35) inset;
    }

    .combat-log::-webkit-scrollbar {
        width: 10px;
    }

    .combat-log::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.06);
        border-radius: 10px;
    }

    .combat-log::-webkit-scrollbar-thumb {
        background: rgba(255, 140, 0, 0.35);
        border-radius: 10px;
        border: 2px solid rgba(0, 0, 0, 0.25);
    }

    .combat-log::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 140, 0, 0.5);
    }

    .log-entry {
        padding: 6px;
        margin: 4px 0;
        border-radius: 5px;
        animation: slideIn 0.3s;
    }

    @keyframes slideIn {
        from { transform: translateX(-20px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    .log-attack { background: rgba(231, 76, 60, 0.3); border-left: 3px solid #e74c3c; }
    .log-damage { background: rgba(192, 57, 43, 0.3); border-left: 3px solid #c0392b; }
    .log-heal { background: rgba(46, 204, 113, 0.3); border-left: 3px solid #2ecc71; }
    .log-miss { background: rgba(149, 165, 166, 0.3); border-left: 3px solid #95a5a6; }
    .log-special { background: rgba(255, 140, 0, 0.3); border-left: 3px solid #ff8c00; }

    .dice-roll {
        display: inline-block;
        background: #ff8c00;
        color: #fff;
        padding: 2px 6px;
        border-radius: 5px;
        font-weight: bold;
        margin: 0 3px;
    }

    .story-text {
        background: rgba(0, 0, 0, 0.4);
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        line-height: 1.8;
        font-size: 1.05em;
        border-left: 4px solid #ff8c00;
        box-shadow: 0 10px 26px rgba(0, 0, 0, 0.35);
    }

    .story-text h2 {
        letter-spacing: 0.6px;
        text-shadow: 0 0 14px rgba(255, 140, 0, 0.25);
    }

    .mission-list, .jutsu-academy-list {
        display: grid;
        gap: 10px;
        margin-top: 20px;
    }

    .mission-card, .jutsu-card {
        background: rgba(74, 85, 131, 0.22);
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #ff8c00;
        cursor: pointer;
        transition: all 0.3s;
        border-top: 1px solid rgba(255, 255, 255, 0.06);
        border-right: 1px solid rgba(255, 255, 255, 0.04);
        border-bottom: 1px solid rgba(0, 0, 0, 0.25);
    }

    .mission-card:hover, .jutsu-card:hover {
        background: rgba(74, 85, 131, 0.38);
        transform: translateX(6px);
    }

    .mission-card h4, .jutsu-card h4 {
        color: #ff8c00;
        margin-bottom: 8px;
    }

    .shop-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    .shop-item {
        background: rgba(74, 85, 131, 0.22);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid rgba(74, 85, 131, 0.6);
        box-shadow: 0 12px 26px rgba(0, 0, 0, 0.35);
        transition: transform 0.2s, background 0.2s, border-color 0.2s;
    }

    .shop-item:hover {
        transform: translateY(-2px);
        background: rgba(74, 85, 131, 0.32);
        border-color: rgba(255, 140, 0, 0.45);
    }

    .shop-item h4 {
        color: #ff8c00;
        margin-bottom: 8px;
    }

    .shop-item .price {
        color: var(--gold);
        font-weight: bold;
        margin: 8px 0;
    }

    .jutsu-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 15px;
    }

    .jutsu-btn {
        background: rgba(52, 152, 219, 0.3);
        border: 2px solid #3498db;
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: left;
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.3);
    }

    .jutsu-btn:hover:not(:disabled) {
        background: rgba(52, 152, 219, 0.5);
        transform: scale(1.05);
    }

    .jutsu-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .jutsu-btn h4 {
        color: #3498db;
        margin-bottom: 5px;
    }

    .kekkei-genkai-notification {
        background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
        color: #000;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        margin: 20px 0;
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        padding: 10px;
        background: rgba(0, 0, 0, 0.22);
        border: 1px solid rgba(74, 85, 131, 0.45);
        border-radius: 12px;
    }

    .tab-btn {
        background: rgba(74, 85, 131, 0.5);
        border: 2px solid #4a5583;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        color: #fff;
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.25);
        user-select: none;
    }

    .tab-btn.active {
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
        border-color: rgba(255, 140, 0, 0.95);
        box-shadow: 0 10px 22px rgba(255, 140, 0, 0.25);
    }

    .tab-btn:hover:not(.active) {
        transform: translateY(-1px);
        background: rgba(74, 85, 131, 0.65);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .victory {
        text-align: center;
        padding: 30px;
        background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
        border-radius: 10px;
        color: #000;
        box-shadow: 0 18px 50px rgba(0, 0, 0, 0.45);
    }

    .defeat {
        text-align: center;
        padding: 30px;
        background: linear-gradient(135deg, #8b0000 0%, #c0392b 100%);
        border-radius: 10px;
        box-shadow: 0 18px 50px rgba(0, 0, 0, 0.45);
    }

    .kekkei-level {
        background: rgba(255, 215, 0, 0.2);
        border: 2px solid #ffd700;
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
        box-shadow: 0 10px 26px rgba(0, 0, 0, 0.35);
    }

    .progress-bar {
        width: 100%;
        height: 20px;
        background: #333;
        border-radius: 10px;
        overflow: hidden;
        margin: 8px 0;
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.35) inset;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #ffd700 0%, #ff8c00 100%);
        transition: width 0.5s;
    }

    @media (max-width: 600px) {
        .game-container {
            padding: 15px;
        }
        
        h1 {
            font-size: 1.8em;
        }

        .tabs {
            padding: 8px;
        }

        .tab-btn {
            flex: 1 1 auto;
        }
        
        .clan-select {
            grid-template-columns: 1fr;
        }

        .shop-grid {
            grid-template-columns: 1fr;
        }
    }

    .element-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 5px;
        font-size: 0.85em;
        font-weight: bold;
        margin: 3px;
    }

    .element-fire { background: #e74c3c; color: white; }
    .element-water { background: #3498db; color: white; }
    .element-wind { background: #95a5a6; color: white; }
    .element-earth { background: #795548; color: white; }
    .element-lightning { background: #f1c40f; color: black; }

    .learned-jutsu {
        background: rgba(46, 204, 113, 0.3);
        border: 2px solid #2ecc71;
        padding: 10px;
        border-radius: 8px;
        margin: 5px 0;
    }

    /* Mejor consistencia visual en contenido generado (stats/inventario) */
    #stats-display .player-info {
        margin-top: 15px;
    }

    #stats-display h3 {
        color: var(--accent);
        margin-bottom: 10px;
        text-shadow: 0 0 12px rgba(255, 140, 0, 0.25);
    }

    #combat-items-list .mission-card,
    #combat-items-list .jutsu-card,
    #combat-items-list .shop-item {
        margin: 8px 0;
    }
</style>
```

</head>
<body>
    <div class="game-container">
        <h1>üç• NINJA RPG üç•</h1>

```
    <!-- Pantalla de Inicio con Load -->
    <div id="start-screen" class="screen active">
        <div class="story-text">
            <h2 style="color: #ff8c00; text-align: center; margin-bottom: 15px;">Bienvenido a la Aldea Oculta</h2>
            <p>En un mundo donde el poder del chakra fluye a trav√©s de todo ser vivo, los ninjas son los guerreros m√°s poderosos.</p>
            <p>Nacer√°s en uno de los clanes m√°s prestigiosos de Konoha. Tu destino est√° por comenzar...</p>
            <p style="margin-top: 15px; color: #ffd700;">‚ö° Los Kekkei Genkai son extremadamente raros...</p>
        </div>
        <div style="text-align: center;">
            <button class="btn" onclick="game.showClanSelect()">Nueva Partida</button>
            <button class="btn btn-secondary" onclick="game.loadGame()" id="load-btn">Cargar Partida</button>
        </div>
    </div>

    <!-- Selecci√≥n de Clan -->
    <div id="clan-screen" class="screen">
        <h2 style="text-align: center; color: #ff8c00; margin-bottom: 20px;">Elige Tu Clan</h2>
        <div class="clan-select" id="clan-select"></div>
    </div>

    <!-- Sorteo de Kekkei Genkai -->
    <div id="kekkei-screen" class="screen">
        <div class="kekkei-genkai-notification" id="kekkei-result">
            <h2>üåü Realizando Sorteo de Kekkei Genkai... üåü</h2>
        </div>
        <div style="text-align: center;">
            <button class="btn" onclick="game.finishCharacterCreation()">Continuar</button>
        </div>
    </div>

    <!-- Pantalla Principal (Aldea) -->
    <div id="village-screen" class="screen">
        <div class="player-info">
            <h2 id="player-name-village" style="color: #ff8c00;">Ninja</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <div class="health-bar">
                        <div class="health-fill" id="village-health-bar">HP: 100/100</div>
                    </div>
                </div>
                <div>
                    <div class="chakra-bar">
                        <div class="chakra-fill" id="village-chakra-bar">Chakra: 100/100</div>
                    </div>
                </div>
            </div>
            <div class="info-grid">
                <div class="info-item">ü•∑ Rango: <span id="player-rank">Genin</span></div>
                <div class="info-item">‚≠ê Nivel: <span id="player-level-village">1</span></div>
                <div class="info-item">üí∞ Ryo: <span id="player-ryo">100</span></div>
                <div class="info-item">‚ú® EXP: <span id="player-exp-village">0/100</span></div>
            </div>
            <div id="kekkei-display" style="margin-top: 10px;"></div>
            <div id="element-display" style="margin-top: 5px; text-align: center;"></div>
        </div>

        <div style="text-align: center; margin-bottom: 15px;">
            <button class="btn btn-small btn-secondary" onclick="game.saveGame()">üíæ Guardar Partida</button>
            <button class="btn btn-small" onclick="game.restInVillage()">üò¥ Descansar (Recuperar todo)</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="game.showTab('missions')">üìú Misiones</button>
            <button class="tab-btn" onclick="game.showTab('academy')">üéì Academia</button>
            <button class="tab-btn" onclick="game.showTab('shop')">üè™ Tienda</button>
            <button class="tab-btn" onclick="game.showTab('training')">üí™ Entrenamiento</button>
            <button class="tab-btn" onclick="game.showTab('stats')">üìä Stats</button>
        </div>

        <div id="missions-tab" class="tab-content active">
            <h3 style="color: #ff8c00;">Misiones Disponibles</h3>
            <div class="mission-list" id="mission-list"></div>
        </div>

        <div id="academy-tab" class="tab-content">
            <h3 style="color: #ff8c00;">üéì Academia Ninja</h3>
            <p style="margin: 10px 0;">Aprende nuevos jutsus pagando con Ryo. Los jutsus m√°s poderosos requieren un rango ninja m√°s alto.</p>
            
            <div class="tabs" style="margin-top: 20px;">
                <button class="tab-btn active" onclick="game.showJutsuRank('genin')">Genin</button>
                <button class="tab-btn" onclick="game.showJutsuRank('chunin')">Chunin</button>
                <button class="tab-btn" onclick="game.showJutsuRank('jonin')">Jonin</button>
                <button class="tab-btn" onclick="game.showJutsuRank('master')">Maestros</button>
            </div>
            
            <div class="jutsu-academy-list" id="academy-jutsu-list"></div>
        </div>

        <div id="shop-tab" class="tab-content">
            <h3 style="color: #ff8c00;">Tienda de la Aldea</h3>
            <div class="shop-grid" id="shop-list"></div>
        </div>

        <div id="training-tab" class="tab-content">
            <h3 style="color: #ff8c00;">Centro de Entrenamiento</h3>
            <div class="shop-grid" id="training-list"></div>
        </div>

        <div id="stats-tab" class="tab-content">
            <h3 style="color: #ff8c00;">Tus Estad√≠sticas</h3>
            <div id="stats-display"></div>
        </div>
    </div>

    <!-- Combate -->
    <div id="combat-screen" class="screen">
        <div class="player-info">
            <h3 id="combat-player-name">Tu Ninja</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <div class="health-bar">
                        <div class="health-fill" id="combat-player-health-bar">HP: 100/100</div>
                    </div>
                </div>
                <div>
                    <div class="chakra-bar">
                        <div class="chakra-fill" id="combat-player-chakra-bar">Chakra: 100/100</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="combat-area">
            <div class="enemy-info">
                <h3 id="enemy-name">Enemigo</h3>
                <div class="health-bar">
                    <div class="health-fill" id="enemy-health-bar" style="background: linear-gradient(90deg, #8b0000 0%, #660000 100%);">HP: 50/50</div>
                </div>
                <p id="enemy-stats"></p>
            </div>

            <div class="combat-log" id="combat-log"></div>

            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-small" onclick="game.basicAttack()" id="attack-btn">‚öîÔ∏è Taijutsu</button>
                <button class="btn btn-small" onclick="game.toggleJutsuMenu()" id="jutsu-menu-btn">üåÄ Ninjutsu</button>
                <button class="btn btn-small" onclick="game.useGenjutsu()" id="genjutsu-btn">üëÅÔ∏è Genjutsu</button>
                <button class="btn btn-small" onclick="game.defend()" id="defend-btn">üõ°Ô∏è Defender</button>
                <button class="btn btn-small" onclick="game.useKawarimi()" id="kawarimi-btn">üí® Kawarimi</button>
                <button class="btn btn-small" onclick="game.showInventoryInCombat()" id="item-btn">üéí Items</button>
            </div>

            <div id="jutsu-selection" style="display: none; margin-top: 15px;">
                <h4 style="color: #3498db;">Selecciona un Jutsu:</h4>
                <div class="jutsu-grid" id="jutsu-list"></div>
            </div>

            <div id="combat-inventory" style="display: none; margin-top: 15px;">
                <h4 style="color: #2ecc71;">Items Disponibles:</h4>
                <div id="combat-items-list"></div>
            </div>
        </div>
    </div>

    <!-- Victoria de Misi√≥n -->
    <div id="mission-victory-screen" class="screen">
        <div class="victory">
            <h2>üéâ ¬°MISI√ìN COMPLETADA! üéâ</h2>
            <p id="mission-victory-text"></p>
            <div id="kekkei-exp-gain" style="margin-top: 15px;"></div>
            <button class="btn" onclick="game.returnToVillage()">Regresar a la Aldea</button>
        </div>
    </div>

    <!-- Derrota -->
    <div id="defeat-screen" class="screen">
        <div class="defeat">
            <h2>üíÄ HAS CA√çDO EN BATALLA üíÄ</h2>
            <p>El camino del ninja es dif√≠cil...</p>
            <p style="margin-top: 15px;">Tu personaje ha muerto. Debes crear uno nuevo.</p>
            <button class="btn" onclick="game.deleteCharacterAndRestart()">Crear Nuevo Personaje</button>
        </div>
    </div>
</div>

<script>
    const game = {
        player: null,
        currentEnemy: null,
        currentMission: null,
        enemyQueue: [],
        currentWave: 0,
        totalWaves: 0,
        combatTurn: 'player',
        kawairimiUsed: false,
        defendActive: false,

        // Calendario ninja
        weekdayNames: ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'],
        monthNames: [
            'Mes 1', 'Mes 2', 'Mes 3', 'Mes 4', 'Mes 5', 'Mes 6',
            'Mes 7', 'Mes 8', 'Mes 9', 'Mes 10', 'Mes 11', 'Mes 12'
        ],
        timeOfDayNames: ['MA√ëANA', 'TARDE', 'NOCHE', 'MADRUGADA'],
        turnsPerDay: 4,
        daysPerMonth: 30,
        monthsPerYear: 12,

        // Mundo / mapa
        locations: {
            konoha: { name: 'Konoha', icon: 'üèòÔ∏è', base: true },
            bosque: { name: 'Bosque de la Muerte', icon: 'üå≤', daysFromKonoha: 2 },
            olas: { name: 'Pa√≠s de las Olas', icon: 'üåä', daysFromKonoha: 3 },
            suna: { name: 'Sunagakure', icon: 'üèúÔ∏è', daysFromKonoha: 5 },
            kiri: { name: 'Kirigakure', icon: 'üå´Ô∏è', daysFromKonoha: 7 },
            iwa: { name: 'Iwagakure', icon: '‚õ∞Ô∏è', daysFromKonoha: 6 },
            kumo: { name: 'Kumogakure', icon: '‚òÅÔ∏è', daysFromKonoha: 8 },
            ame: { name: 'Amegakure', icon: 'üíß', daysFromKonoha: 4 },
            valle: { name: 'Valle del Fin', icon: 'üå≥', daysFromKonoha: 4 },
            nieve: { name: 'Pa√≠s de la Nieve', icon: 'üèîÔ∏è', daysFromKonoha: 10 }
        },

        // Reclutamiento (equipo de 3: t√∫ + 2 NPC)
        recruitableNPCs: {
            naruto: { id: 'naruto', name: 'Naruto', costPerDay: 500, perk: 'mission_ryo', perkValue: 0.10 },
            sakura: { id: 'sakura', name: 'Sakura', costPerDay: 400, perk: 'between_heal', perkValue: 0.10 },
            lee: { id: 'lee', name: 'Rock Lee', costPerDay: 450, perk: 'combat_damage', perkValue: 15 },
            shikamaru: { id: 'shikamaru', name: 'Shikamaru', costPerDay: 600, perk: 'mission_exp', perkValue: 0.20 },
            hinata: { id: 'hinata', name: 'Hinata', costPerDay: 550, perk: 'team_evasion', perkValue: 0.15 }
        },

        // Clima
        weatherOptionsBySeason: {
            primavera: ['soleado', 'soleado', 'nublado', 'lluvia'],
            verano: ['soleado', 'soleado', 'soleado', 'nublado', 'tormenta'],
            otono: ['nublado', 'lluvia', 'lluvia', 'soleado'],
            invierno: ['nublado', 'nieve', 'nieve', 'tormenta']
        },

        // Eventos recurrentes
        recurringEvents: [
            { id: 'festival_konoha', name: 'Festival de Konoha', when: (p) => p.location === 'konoha' && p.month === 5 && p.day === 15 },
            { id: 'examen_chunin_enero', name: 'Examen Chunin', when: (p) => p.location === 'konoha' && p.month === 1 && p.day === 1 },
            { id: 'examen_chunin_julio', name: 'Examen Chunin', when: (p) => p.location === 'konoha' && p.month === 7 && p.day === 1 },
            { id: 'luna_llena', name: 'Luna Llena', when: (p) => p.day === 15 },
            { id: 'torneo_aldea', name: 'Torneo de la Aldea', when: (p) => p.location === 'konoha' && p.day === 30 }
        ],
        
        clans: {
            uchiha: {
                name: 'Uchiha',
                icon: 'üî•',
                description: 'Clan del fuego',
                hp: 100, chakra: 120, taijutsu: 12, ninjutsu: 18, genjutsu: 15,
                element: 'fire'
            },
            uzumaki: {
                name: 'Uzumaki',
                icon: 'üåÄ',
                description: 'Vitalidad extrema',
                hp: 140, chakra: 150, taijutsu: 15, ninjutsu: 14, genjutsu: 8,
                element: 'wind'
            },
            hyuga: {
                name: 'Hyuga',
                icon: 'üëÅÔ∏è',
                description: 'Visi√≥n perfecta',
                hp: 110, chakra: 100, taijutsu: 20, ninjutsu: 10, genjutsu: 12,
                element: 'water'
            },
            nara: {
                name: 'Nara',
                icon: 'ü¶å',
                description: 'Estrategas',
                hp: 90, chakra: 110, taijutsu: 10, ninjutsu: 15, genjutsu: 18,
                element: 'earth'
            },
            akimichi: {
                name: 'Akimichi',
                icon: 'üçñ',
                description: 'Fuerza colosal',
                hp: 150, chakra: 90, taijutsu: 18, ninjutsu: 12, genjutsu: 8,
                element: 'earth'
            },
            aburame: {
                name: 'Aburame',
                icon: 'üêõ',
                description: 'Control de insectos',
                hp: 95, chakra: 115, taijutsu: 11, ninjutsu: 16, genjutsu: 14,
                element: 'earth'
            },
            inuzuka: {
                name: 'Inuzuka',
                icon: 'üê∫',
                description: 'V√≠nculo bestial',
                hp: 115, chakra: 95, taijutsu: 17, ninjutsu: 11, genjutsu: 10,
                element: 'earth'
            },
            yamanaka: {
                name: 'Yamanaka',
                icon: 'üå∏',
                description: 'Control mental',
                hp: 85, chakra: 125, taijutsu: 9, ninjutsu: 13, genjutsu: 20,
                element: 'water'
            },
            hatake: {
                name: 'Hatake',
                icon: '‚ö°',
                description: 'Copistas',
                hp: 105, chakra: 130, taijutsu: 14, ninjutsu: 17, genjutsu: 13,
                element: 'lightning'
            },
            senju: {
                name: 'Senju',
                icon: 'üå≥',
                description: 'Equilibrio perfecto',
                hp: 120, chakra: 120, taijutsu: 15, ninjutsu: 15, genjutsu: 15,
                element: 'earth'
            },
            sarutobi: {
                name: 'Sarutobi',
                icon: 'üîÆ',
                description: 'Maestros elementales',
                hp: 100, chakra: 140, taijutsu: 12, ninjutsu: 19, genjutsu: 11,
                element: 'fire'
            },
            rock_lee: {
                name: 'Sin Clan (Lee)',
                icon: 'üëä',
                description: 'Puro Taijutsu',
                hp: 130, chakra: 50, taijutsu: 25, ninjutsu: 5, genjutsu: 5,
                element: null
            }
        },

        kekkeiGenkaiList: [
            { 
                name: 'Sharingan', 
                chance: 3, 
                levels: [
                    { level: 1, name: '1 Aspa', exp: 0, bonus: { genjutsu: 3, critChance: 5 } },
                    { level: 2, name: '2 Aspas', exp: 100, bonus: { genjutsu: 5, critChance: 10 } },
                    { level: 3, name: '3 Aspas', exp: 300, bonus: { genjutsu: 8, critChance: 15 } },
                    { level: 4, name: 'Mangeky≈ç', exp: 600, bonus: { genjutsu: 12, critChance: 20, ninjutsu: 5 } }
                ]
            },
            { 
                name: 'Byakugan', 
                chance: 3, 
                levels: [
                    { level: 1, name: 'B√°sico', exp: 0, bonus: { taijutsu: 3, critChance: 8 } },
                    { level: 2, name: 'Intermedio', exp: 100, bonus: { taijutsu: 6, critChance: 15 } },
                    { level: 3, name: 'Avanzado', exp: 300, bonus: { taijutsu: 10, critChance: 22 } },
                    { level: 4, name: 'Tenseigan', exp: 700, bonus: { taijutsu: 15, critChance: 30, chakraRegen: 10 } }
                ]
            },
            { 
                name: 'Rinnegan', 
                chance: 0.5, 
                levels: [
                    { level: 1, name: '6 Caminos', exp: 0, bonus: { all: 10, critChance: 25 } },
                    { level: 2, name: 'Rinne-Sharingan', exp: 500, bonus: { all: 20, critChance: 40 } }
                ]
            },
            { 
                name: 'Modo Sabio', 
                chance: 2, 
                levels: [
                    { level: 1, name: 'B√°sico', exp: 0, bonus: { ninjutsu: 5, chakraRegen: 3 } },
                    { level: 2, name: 'Avanzado', exp: 150, bonus: { ninjutsu: 10, chakraRegen: 7 } },
                    { level: 3, name: 'Perfecto', exp: 400, bonus: { ninjutsu: 15, chakraRegen: 12, maxChakra: 50 } }
                ]
            },
            { 
                name: 'Mokuton', 
                chance: 1.5, 
                levels: [
                    { level: 1, name: 'B√°sico', exp: 0, bonus: { ninjutsu: 4, maxHp: 15 } },
                    { level: 2, name: 'Hashirama', exp: 200, bonus: { ninjutsu: 8, maxHp: 40 } }
                ]
            }
        ],

        elements: {
            fire: { name: 'Fuego (Katon)', icon: 'üî•', bonus: 'Da√±o quemadura' },
            water: { name: 'Agua (Suiton)', icon: 'üíß', bonus: '+Defensa' },
            wind: { name: 'Viento (Futon)', icon: 'üí®', bonus: '+Velocidad' },
            earth: { name: 'Tierra (Doton)', icon: 'ü™®', bonus: '+HP' },
            lightning: { name: 'Rayo (Raiton)', icon: '‚ö°', bonus: '+Cr√≠tico' }
        },

        academyJutsus: {
            genin: [
                { name: 'Katon: Peque√±a Llama', rank: 'D', price: 100, chakra: 15, damage: 20, element: 'fire', description: 'Jutsu b√°sico de fuego' },
                { name: 'Suiton: Bala de Agua', rank: 'D', price: 100, chakra: 15, damage: 18, element: 'water', description: 'Dispara agua' },
                { name: 'Futon: Ventisca', rank: 'D', price: 100, chakra: 15, damage: 22, element: 'wind', description: 'R√°faga de viento' },
                { name: 'Doton: Pared de Tierra', rank: 'D', price: 100, chakra: 20, damage: 0, effect: 'defense', element: 'earth', description: '+Defensa temporal' },
                { name: 'Raiton: Chispa', rank: 'D', price: 100, chakra: 15, damage: 19, element: 'lightning', description: 'Descarga el√©ctrica' },
                { name: 'Kage Bunshin', rank: 'C', price: 300, chakra: 40, damage: 0, effect: 'clone', description: 'Crea un clon' },
                { name: 'Shunshin', rank: 'C', price: 250, chakra: 30, damage: 0, effect: 'speed', description: 'Aumenta velocidad' }
            ],
            chunin: [
                { name: 'Katon: Gran Bola de Fuego', rank: 'C', price: 500, chakra: 35, damage: 45, element: 'fire', description: 'Bola de fuego poderosa' },
                { name: 'Suiton: Drag√≥n de Agua', rank: 'B', price: 800, chakra: 50, damage: 60, element: 'water', description: 'Drag√≥n de agua' },
                { name: 'Futon: Rasengan', rank: 'B', price: 1000, chakra: 60, damage: 70, element: 'wind', description: 'Esfera de chakra' },
                { name: 'Doton: Prisi√≥n de Tierra', rank: 'B', price: 700, chakra: 45, damage: 40, effect: 'stun', element: 'earth', description: 'Atrapa al enemigo' },
                { name: 'Raiton: Chidori', rank: 'B', price: 1200, chakra: 55, damage: 75, element: 'lightning', description: 'Mil p√°jaros' },
                { name: 'Invocaci√≥n: Animal', rank: 'B', price: 900, chakra: 50, damage: 50, effect: 'summon', description: 'Invoca un aliado' }
            ],
            jonin: [
                { name: 'Katon: Majestuosa Destrucci√≥n', rank: 'A', price: 2000, chakra: 80, damage: 100, element: 'fire', description: 'Mar de llamas' },
                { name: 'Suiton: Gran Cascada', rank: 'A', price: 2200, chakra: 85, damage: 110, element: 'water', description: 'Tsunami devastador' },
                { name: 'Futon: Rasen-Shuriken', rank: 'A', price: 2500, chakra: 90, damage: 120, element: 'wind', description: 'Rasengan definitivo' },
                { name: 'Raiton: Kirin', rank: 'A', price: 2800, chakra: 95, damage: 130, element: 'lightning', description: 'Bestia de rayos' },
                { name: 'Shinra Tensei', rank: 'S', price: 5000, chakra: 120, damage: 150, description: 'Rechaza todo' }
            ],
            master: [
                { name: 'Edo Tensei', rank: 'S', price: 10000, chakra: 150, damage: 0, effect: 'revive', description: 'Maestro: Resurrecci√≥n prohibida' },
                { name: 'Kamui', rank: 'S', price: 8000, chakra: 100, damage: 80, effect: 'teleport', description: 'Maestro: Espacio-tiempo' },
                { name: 'Tsukuyomi', rank: 'S', price: 7000, chakra: 90, damage: 0, effect: 'mega_genjutsu', description: 'Maestro: Genjutsu supremo' },
                { name: 'Amaterasu', rank: 'S', price: 6000, chakra: 85, damage: 90, effect: 'burn_permanent', description: 'Maestro: Llamas eternas' }
            ]
        },

        shopItems: {
            consumables: [
                { name: 'üçú Ramen Ichiraku', price: 50, effect: { hp: 30 }, description: 'Recupera 30 HP' },
                { name: 'üçô Bento', price: 80, effect: { hp: 50 }, description: 'Recupera 50 HP' },
                { name: 'üíä P√≠ldora de Chakra', price: 100, effect: { chakra: 50 }, description: 'Recupera 50 Chakra' },
                { name: 'üíä P√≠ldora Militar', price: 150, effect: { hp: 80, chakra: 30 }, description: 'Recupera HP y Chakra' },
                { name: 'üíä P√≠ldora 3 Colores', price: 300, effect: { buff: true }, description: '+5 stats por 3 turnos' }
            ],
            weapons: [
                { name: 'üó°Ô∏è Kunai B√°sico', price: 100, effect: { taijutsu: 2 }, description: '+2 Taijutsu' },
                { name: 'üó°Ô∏è Kunai Explosivo', price: 250, effect: { taijutsu: 4 }, description: '+4 Taijutsu' },
                { name: '‚öîÔ∏è Espada Ninja', price: 500, effect: { taijutsu: 6 }, description: '+6 Taijutsu' },
                { name: '‚öîÔ∏è Katana Chakra', price: 1000, effect: { taijutsu: 8, chakraCost: -10 }, description: '+8 Tai, -10% costo chakra' },
                { name: 'üî± Kubikirib≈çch≈ç', price: 3000, effect: { taijutsu: 15, lifesteal: true }, description: '+15 Tai, drena HP' }
            ],
            armor: [
                { name: 'üõ°Ô∏è Chaleco Genin', price: 200, effect: { maxHp: 10 }, description: '+10 HP m√°x' },
                { name: 'üõ°Ô∏è Chaleco Chunin', price: 500, effect: { maxHp: 20, defense: 5 }, description: '+20 HP, +5% defensa' },
                { name: 'üõ°Ô∏è Armadura ANBU', price: 1200, effect: { maxHp: 40, defense: 10 }, description: '+40 HP, +10% defensa' },
                { name: 'üõ°Ô∏è Manto Kage', price: 2500, effect: { maxHp: 60, defense: 15 }, description: '+60 HP, +15% defensa' }
            ]
        },

        training: [
            { name: 'üí™ Entrenamiento Taijutsu', price: 400, effect: { taijutsu: 3 }, description: '+3 Taijutsu permanente' },
            { name: 'üßò Entrenamiento Ninjutsu', price: 400, effect: { ninjutsu: 3 }, description: '+3 Ninjutsu permanente' },
            { name: 'üåÄ Entrenamiento Genjutsu', price: 400, effect: { genjutsu: 3 }, description: '+3 Genjutsu permanente' },
            { name: '‚ö° Aumentar Chakra', price: 350, effect: { maxChakra: 20 }, description: '+20 Chakra m√°ximo' },
            { name: '‚ù§Ô∏è Aumentar HP', price: 350, effect: { maxHp: 15 }, description: '+15 HP m√°ximo' }
        ],

        enemies: {
            genin: [
                { name: 'Bandido', hp: 50, chakra: 20, attack: 12, defense: 6, accuracy: 5, exp: 25, ryo: 50 },
                { name: 'Ninja Renegado Genin', hp: 80, chakra: 40, attack: 15, defense: 8, accuracy: 7, exp: 30, ryo: 75 },
                { name: 'Lobo Salvaje', hp: 60, chakra: 10, attack: 14, defense: 5, accuracy: 8, exp: 28, ryo: 60 }
            ],
            chunin: [
                { name: 'Ninja de la Niebla', hp: 140, chakra: 80, attack: 20, defense: 12, accuracy: 10, exp: 50, ryo: 150 },
                { name: 'Ninja de la Arena', hp: 130, chakra: 90, attack: 22, defense: 11, accuracy: 11, exp: 55, ryo: 160 },
                { name: 'Escuadr√≥n Enemigo (L√≠der)', hp: 160, chakra: 100, attack: 24, defense: 14, accuracy: 12, exp: 60, ryo: 180 },
                { name: 'Ninja de la Roca', hp: 180, chakra: 70, attack: 26, defense: 16, accuracy: 10, exp: 65, ryo: 200 }
            ],
            jonin: [
                { name: 'Jonin √âlite', hp: 220, chakra: 120, attack: 28, defense: 18, accuracy: 14, exp: 80, ryo: 300 },
                { name: 'Jinchuriki Menor', hp: 260, chakra: 150, attack: 32, defense: 20, accuracy: 15, exp: 100, ryo: 400 },
                { name: 'ANBU Renegado', hp: 240, chakra: 140, attack: 30, defense: 22, accuracy: 16, exp: 90, ryo: 350 }
            ],
            akatsuki: [
                { name: 'Hidan', hp: 350, chakra: 180, attack: 38, defense: 25, accuracy: 18, exp: 150, ryo: 800 },
                { name: 'Kakuzu', hp: 400, chakra: 170, attack: 40, defense: 28, accuracy: 19, exp: 160, ryo: 850 },
                { name: 'Sasori', hp: 320, chakra: 200, attack: 36, defense: 24, accuracy: 20, exp: 155, ryo: 820 },
                { name: 'Deidara', hp: 340, chakra: 220, attack: 42, defense: 22, accuracy: 17, exp: 165, ryo: 880 },
                { name: 'Orochimaru', hp: 450, chakra: 250, attack: 45, defense: 30, accuracy: 21, exp: 200, ryo: 1000 }
            ],
            boss: [
                { name: 'Pain (Tend≈ç)', hp: 600, chakra: 300, attack: 50, defense: 35, accuracy: 23, exp: 300, ryo: 2000 },
                { name: 'Madara Uchiha', hp: 800, chakra: 400, attack: 60, defense: 40, accuracy: 25, exp: 500, ryo: 5000 },
                { name: 'Kaguya ≈åtsutsuki', hp: 1000, chakra: 500, attack: 70, defense: 45, accuracy: 28, exp: 800, ryo: 10000 }
            ]
        },

        missions: {
            genin: [
                { name: 'Capturar al Gato Perdido', rank: 'D', description: 'El gato del Daimyo escap√≥...', enemies: [{ type: 'genin', index: 0, count: 1 }], ryo: 50, exp: 25 },
                { name: 'Limpiar el R√≠o', rank: 'D', description: 'Bandidos ensucian el r√≠o.', enemies: [{ type: 'genin', index: 0, count: 2 }], ryo: 100, exp: 40 },
                { name: 'Escoltar Comerciante', rank: 'C', description: 'Protege al comerciante. Grupo de bandidos.', enemies: [{ type: 'genin', index: 0, count: 2 }, { type: 'genin', index: 1, count: 1 }], ryo: 250, exp: 60 },
                { name: 'Recuperar Pergamino', rank: 'C', description: 'Ninja renegado y sus guardias.', enemies: [{ type: 'genin', index: 1, count: 1 }, { type: 'genin', index: 2, count: 1 }], ryo: 350, exp: 70 }
            ],
            chunin: [
                { name: 'Patrulla Fronteriza', rank: 'B', description: 'Escuadr√≥n enemigo detectado.', enemies: [{ type: 'chunin', index: 0, count: 2 }], ryo: 500, exp: 80 },
                { name: 'Defender Aldea Aliada', rank: 'B', description: 'M√∫ltiples ninjas atacan.', enemies: [{ type: 'chunin', index: 0, count: 1 }, { type: 'chunin', index: 1, count: 2 }], ryo: 700, exp: 120 },
                { name: 'Infiltraci√≥n', rank: 'B', description: 'Base enemiga fuertemente custodiada.', enemies: [{ type: 'chunin', index: 1, count: 1 }, { type: 'chunin', index: 3, count: 1 }], ryo: 800, exp: 130 },
                { name: 'Rescate de Reh√©n', rank: 'A', description: 'Equipo √©lite guarda al prisionero.', enemies: [{ type: 'chunin', index: 2, count: 1 }, { type: 'jonin', index: 0, count: 1 }], ryo: 1000, exp: 150 }
            ],
            jonin: [
                { name: 'Escuadr√≥n de √âlite', rank: 'A', description: 'Grupo de Jonin renegados.', enemies: [{ type: 'jonin', index: 0, count: 2 }], ryo: 1500, exp: 180 },
                { name: 'Proteger al Daimyo', rank: 'A', description: 'Oleada de asesinos de √©lite.', enemies: [{ type: 'jonin', index: 1, count: 1 }, { type: 'jonin', index: 2, count: 1 }], ryo: 1800, exp: 210 },
                { name: 'Enfrentar Akatsuki', rank: 'A', description: 'Miembro de Akatsuki con refuerzos.', enemies: [{ type: 'akatsuki', index: 0, count: 1 }, { type: 'jonin', index: 0, count: 1 }], ryo: 2000, exp: 250 },
                { name: 'Destruir Base de Orochimaru', rank: 'S', description: 'Orochimaru y sus guardianes.', enemies: [{ type: 'akatsuki', index: 4, count: 1 }, { type: 'jonin', index: 2, count: 2 }], ryo: 2500, exp: 300 }
            ],
            kage: [
                { name: 'Detener a Akatsuki', rank: 'S', description: 'Dos miembros de Akatsuki juntos!', enemies: [{ type: 'akatsuki', index: 1, count: 1 }, { type: 'akatsuki', index: 3, count: 1 }], ryo: 4000, exp: 400 },
                { name: 'Invasi√≥n de Pain', rank: 'S', description: 'Pain y varios cuerpos!', enemies: [{ type: 'boss', index: 0, count: 1 }, { type: 'akatsuki', index: 0, count: 2 }], ryo: 6000, exp: 500 },
                { name: 'Enfrentar a Madara', rank: 'S', description: 'Madara Uchiha. Batalla suprema.', enemies: [{ type: 'boss', index: 1, count: 1 }], ryo: 8000, exp: 600 },
                { name: 'Guerra Ninja Final', rank: 'S', description: 'Kaguya ≈åtsutsuki. El fin de todo.', enemies: [{ type: 'boss', index: 2, count: 1 }], ryo: 15000, exp: 1000 }
            ]
        },

        rollDice(sides = 20) {
            return Math.floor(Math.random() * sides) + 1;
        },

        showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        },

        showClanSelect() {
            const container = document.getElementById('clan-select');
            container.innerHTML = '';
            
            Object.keys(this.clans).forEach(clanKey => {
                const clan = this.clans[clanKey];
                const card = document.createElement('div');
                card.className = 'clan-card';
                card.onclick = () => this.selectClan(clanKey);
                
                card.innerHTML = `
                    <h3>${clan.icon} ${clan.name}</h3>
                    <p>${clan.description}</p>
                    <div class="clan-stats">
                        <div class="stat">‚ù§Ô∏è HP: ${clan.hp}</div>
                        <div class="stat">üíô Chakra: ${clan.chakra}</div>
                        <div class="stat">üëä Taijutsu: ${clan.taijutsu}</div>
                        <div class="stat">üåÄ Ninjutsu: ${clan.ninjutsu}</div>
                        <div class="stat">üëÅÔ∏è Genjutsu: ${clan.genjutsu}</div>
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            this.showScreen('clan-screen');
        },

        selectClan(clanKey) {
            const clan = this.clans[clanKey];
            this.player = {
                clan: clan.name,
                clanKey: clanKey,
                maxHp: clan.hp,
                hp: clan.hp,
                maxChakra: clan.chakra,
                chakra: clan.chakra,
                taijutsu: clan.taijutsu,
                ninjutsu: clan.ninjutsu,
                genjutsu: clan.genjutsu,
                level: 1,
                exp: 0,
                expToNext: 100,
                ryo: 500,
                rank: 'Genin',
                element: clan.element,
                inventory: [],
                learnedJutsus: [],
                kekkeiGenkai: null,
                kekkeiLevel: 0,
                kekkeiExp: 0,
                permanentBonuses: {},
                combatsWon: 0,

                // Mundo / calendario
                location: 'konoha',
                day: 1,
                month: 1,
                year: 1024,
                timeOfDay: 0, // 0=ma√±ana, 1=tarde, 2=noche, 3=madrugada
                weekday: 0, // 0..6
                weather: 'soleado',
                season: 'primavera',

                // Sistemas
                fatigue: 0, // 0..100
                team: [], // hasta 2 NPCs
                friendship: {}, // npcId -> 0..100
                reputation: {
                    konoha: 50,
                    bosque: 0,
                    olas: 0,
                    suna: 0,
                    kiri: 0,
                    iwa: 0,
                    kumo: 0,
                    ame: 0,
                    valle: 0,
                    nieve: 0
                },

                // Misiones con tiempo
                urgentMission: null
            };
            
            this.doKekkeiGenkaiRoll();
        },

        doKekkeiGenkaiRoll() {
            this.showScreen('kekkei-screen');
            
            setTimeout(() => {
                const roll = Math.random() * 100;
                let wonKekkei = null;
                
                for (let kg of this.kekkeiGenkaiList) {
                    if (roll <= kg.chance) {
                        wonKekkei = kg;
                        break;
                    }
                }
                
                const resultDiv = document.getElementById('kekkei-result');
                
                if (wonKekkei) {
                    this.player.kekkeiGenkai = wonKekkei;
                    this.player.kekkeiLevel = 1;
                    this.player.kekkeiExp = 0;
                    this.applyKekkeiGenkaiBonuses();
                    
                    resultDiv.innerHTML = `
                        <h2>üåü ¬°KEKKEI GENKAI DESBLOQUEADO! üåü</h2>
                        <h1 style="font-size: 2.5em; margin: 20px 0;">${wonKekkei.name}</h1>
                        <p style="font-size: 1.2em;">${wonKekkei.levels[0].name}</p>
                        <p style="margin-top: 15px; color: #000;">¬°Eres uno de los POCOS elegidos! (${kg.chance}% de probabilidad)</p>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <h2>Sorteo de Kekkei Genkai</h2>
                        <p style="font-size: 1.2em; margin: 20px 0;">No fuiste bendecido con un Kekkei Genkai...</p>
                        <p>Los Kekkei Genkai son extremadamente raros. Tu determinaci√≥n te har√° fuerte.</p>
                    `;
                    resultDiv.style.background = 'linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%)';
                }
            }, 1000);
        },

        applyKekkeiGenkaiBonuses() {
            if (!this.player.kekkeiGenkai) return;
            
            const currentLevel = this.player.kekkeiGenkai.levels[this.player.kekkeiLevel - 1];
            const bonus = currentLevel.bonus;
            
            if (bonus.all) {
                this.player.taijutsu += bonus.all;
                this.player.ninjutsu += bonus.all;
                this.player.genjutsu += bonus.all;
            }
            if (bonus.taijutsu) this.player.taijutsu += bonus.taijutsu;
            if (bonus.ninjutsu) this.player.ninjutsu += bonus.ninjutsu;
            if (bonus.genjutsu) this.player.genjutsu += bonus.genjutsu;
            if (bonus.maxHp) {
                this.player.maxHp += bonus.maxHp;
                this.player.hp = this.player.maxHp;
            }
            if (bonus.maxChakra) {
                this.player.maxChakra += bonus.maxChakra;
                this.player.chakra = this.player.maxChakra;
            }
            
            this.player.critChance = bonus.critChance || 0;
            this.player.chakraRegen = bonus.chakraRegen || 0;
        },

        finishCharacterCreation() {
            this.showScreen('village-screen');
            this.updateVillageUI();
            this.showMissions();
            this.saveGame();
        },

        updateVillageUI() {
            document.getElementById('player-name-village').textContent = `${this.player.clan} Ninja`;
            document.getElementById('player-rank').textContent = this.player.rank;
            document.getElementById('player-level-village').textContent = this.player.level;
            document.getElementById('player-ryo').textContent = this.player.ryo;
            document.getElementById('player-exp-village').textContent = `${this.player.exp}/${this.player.expToNext}`;
            
            this.updateBar('village-health-bar', this.player.hp, this.player.maxHp, 'HP');
            this.updateBar('village-chakra-bar', this.player.chakra, this.player.maxChakra, 'Chakra');
            
            const kekkeiDisplay = document.getElementById('kekkei-display');
            if (this.player.kekkeiGenkai) {
                const currentLevel = this.player.kekkeiGenkai.levels[this.player.kekkeiLevel - 1];
                const nextLevel = this.player.kekkeiGenkai.levels[this.player.kekkeiLevel];
                
                let html = `<div class="kekkei-level">
                    <div style="text-align: center;">
                        <span style="background: linear-gradient(135deg, #ffd700, #ff8c00); color: #000; padding: 5px 15px; border-radius: 8px; font-weight: bold;">
                            ‚ö° ${this.player.kekkeiGenkai.name} - ${currentLevel.name}
                        </span>
                    </div>`;
                
                if (nextLevel) {
                    const expNeeded = nextLevel.exp - this.player.kekkeiExp;
                    const progress = (this.player.kekkeiExp / nextLevel.exp) * 100;
                    html += `
                        <p style="margin-top: 10px; text-align: center; font-size: 0.9em;">
                            EXP Kekkei: ${this.player.kekkeiExp} / ${nextLevel.exp}
                        </p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <p style="text-align: center; font-size: 0.85em; color: #ffd700;">
                            Pr√≥ximo: ${nextLevel.name} (${expNeeded} EXP)
                        </p>`;
                } else {
                    html += `<p style="margin-top: 10px; text-align: center; color: #ffd700;">¬°NIVEL M√ÅXIMO!</p>`;
                }
                
                html += `</div>`;
                kekkeiDisplay.innerHTML = html;
            } else {
                kekkeiDisplay.innerHTML = '';
            }
            
            const elementDisplay = document.getElementById('element-display');
            if (this.player.element) {
                const elem = this.elements[this.player.element];
                elementDisplay.innerHTML = `<span class="element-badge element-${this.player.element}">${elem.icon} ${elem.name}</span>`;
            }

            this.ensureWorldHUD();
            this.updateWorldHUD();
        },

        updateBar(elementId, current, max, label) {
            const bar = document.getElementById(elementId);
            const percentage = (current / max) * 100;
            bar.style.width = percentage + '%';
            bar.textContent = `${label}: ${Math.max(0, Math.floor(current))}/${max}`;
        },

        // -----------------------------
        // Mundo / calendario (n√∫cleo)
        // -----------------------------
        migratePlayerSave() {
            if (!this.player) return;

            const defaults = {
                location: 'konoha',
                day: 1,
                month: 1,
                year: 1024,
                timeOfDay: 0,
                weekday: 0,
                weather: 'soleado',
                season: 'primavera',
                fatigue: 0,
                team: [],
                friendship: {},
                reputation: {
                    konoha: 50,
                    bosque: 0,
                    olas: 0,
                    suna: 0,
                    kiri: 0,
                    iwa: 0,
                    kumo: 0,
                    ame: 0,
                    valle: 0,
                    nieve: 0
                },
                urgentMission: null
            };

            for (const [key, value] of Object.entries(defaults)) {
                if (this.player[key] === undefined || this.player[key] === null) {
                    this.player[key] = (typeof structuredClone === 'function')
                        ? structuredClone(value)
                        : JSON.parse(JSON.stringify(value));
                }
            }

            // Normalizar
            this.player.fatigue = this.clamp(this.player.fatigue, 0, 100);
            this.player.timeOfDay = this.clamp(this.player.timeOfDay, 0, 3);
            this.player.weekday = this.clamp(this.player.weekday, 0, 6);
            this.player.day = this.clamp(this.player.day, 1, this.daysPerMonth);
            this.player.month = this.clamp(this.player.month, 1, this.monthsPerYear);
            this.player.year = Math.max(1, this.player.year);

            this.updateSeasonAndWeather(false);
        },

        clamp(value, min, max) {
            return Math.min(max, Math.max(min, value));
        },

        getSeasonFromMonth(month) {
            if (month >= 1 && month <= 3) return 'primavera';
            if (month >= 4 && month <= 6) return 'verano';
            if (month >= 7 && month <= 9) return 'otono';
            return 'invierno';
        },

        rollWeatherForSeason(season) {
            const options = this.weatherOptionsBySeason[season] || ['soleado'];
            const idx = Math.floor(Math.random() * options.length);
            return options[idx];
        },

        updateSeasonAndWeather(rollWeather = true) {
            this.player.season = this.getSeasonFromMonth(this.player.month);
            if (rollWeather) {
                this.player.weather = this.rollWeatherForSeason(this.player.season);
            }
        },

        getTimeOfDayLabel() {
            return this.timeOfDayNames[this.player.timeOfDay] || 'MA√ëANA';
        },

        getSeasonLabel() {
            const map = { primavera: 'Primavera', verano: 'Verano', otono: 'Oto√±o', invierno: 'Invierno' };
            return map[this.player.season] || 'Primavera';
        },

        getWeatherLabel() {
            const map = { soleado: 'Soleado', nublado: 'Nublado', lluvia: 'Lluvia', tormenta: 'Tormenta', nieve: 'Nieve' };
            return map[this.player.weather] || 'Soleado';
        },

        addFatigue(amount) {
            this.player.fatigue = this.clamp(this.player.fatigue + amount, 0, 100);
        },

        reduceFatigue(amount) {
            this.player.fatigue = this.clamp(this.player.fatigue - amount, 0, 100);
        },

        getFatiguePenalty() {
            const f = this.player.fatigue;
            if (f <= 25) return 0;
            if (f <= 50) return 5;
            if (f <= 75) return 10;
            return 20;
        },

        checkFatigueFaint() {
            // 76-100%: riesgo de desmayo
            if (!this.player) return false;
            if (this.player.fatigue < 76) return false;

            const chance = 0.15;
            if (Math.random() >= chance) return false;

            this.disableCombatButtons();
            this.addCombatLog('üòµ Te desmayas por la fatiga y pierdes tu turno.', 'log-miss');
            setTimeout(() => this.enemyTurn(), 1200);
            return true;
        },

        getEffectiveStats() {
            const penalty = this.getFatiguePenalty();
            const base = {
                taijutsu: this.player.taijutsu,
                ninjutsu: this.player.ninjutsu,
                genjutsu: this.player.genjutsu
            };

            const team = this.getTeamBonuses();
            return {
                taijutsu: Math.max(1, base.taijutsu - penalty),
                ninjutsu: Math.max(1, base.ninjutsu - penalty),
                genjutsu: Math.max(1, base.genjutsu - penalty),
                combatDamageBonus: team.combatDamageBonus,
                teamEvasionBonus: team.teamEvasionBonus,
                missionRyoMult: team.missionRyoMult,
                missionExpMult: team.missionExpMult,
                travelDayDelta: team.travelDayDelta,
                betweenCombatHealPct: team.betweenCombatHealPct
            };
        },

        getTeamBonuses() {
            const bonuses = {
                missionRyoMult: 1,
                missionExpMult: 1,
                travelDayDelta: 0,
                combatDamageBonus: 0,
                teamEvasionBonus: 0,
                betweenCombatHealPct: 0
            };

            const team = Array.isArray(this.player.team) ? this.player.team : [];
            if (team.length > 0) {
                // Viajar m√°s r√°pido y seguro
                bonuses.travelDayDelta = -1;
            }

            for (const npcId of team) {
                const npc = this.recruitableNPCs[npcId];
                if (!npc) continue;
                if (npc.perk === 'mission_ryo') bonuses.missionRyoMult *= (1 + npc.perkValue);
                if (npc.perk === 'mission_exp') bonuses.missionExpMult *= (1 + npc.perkValue);
                if (npc.perk === 'combat_damage') bonuses.combatDamageBonus += npc.perkValue;
                if (npc.perk === 'team_evasion') bonuses.teamEvasionBonus += npc.perkValue;
                if (npc.perk === 'between_heal') bonuses.betweenCombatHealPct += npc.perkValue;
            }
            return bonuses;
        },

        advanceTurns(turns, reason = '') {
            if (!this.player) return;

            // Misiones urgentes: el tiempo corre con cualquier acci√≥n
            this.tickUrgentMission(turns);

            for (let i = 0; i < turns; i++) {
                // Avanza turno del d√≠a
                this.player.timeOfDay = (this.player.timeOfDay + 1) % this.turnsPerDay;

                // Regeneraci√≥n pasiva muy leve por turno (afectada por tarde)
                const baseRegen = Math.max(1, Math.floor(this.player.maxChakra * 0.02));
                const regenMultiplier = this.player.timeOfDay === 1 ? 0.9 : 1; // tarde
                const regen = Math.floor(baseRegen * regenMultiplier);
                this.player.chakra = Math.min(this.player.maxChakra, this.player.chakra + regen);

                // Cambio de d√≠a
                if (this.player.timeOfDay === 0) {
                    this.player.day += 1;
                    this.player.weekday = (this.player.weekday + 1) % 7;

                    if (this.player.day > this.daysPerMonth) {
                        this.player.day = 1;
                        this.player.month += 1;
                        if (this.player.month > this.monthsPerYear) {
                            this.player.month = 1;
                            this.player.year += 1;
                        }
                    }

                    this.updateSeasonAndWeather(true);
                    this.applyDailyUpkeep();
                    this.checkRandomDailyEvents();
                }
            }

            this.checkRecurringEvents();
            this.saveGame();

            if (this.isVillageScreenActive()) {
                this.updateVillageUI();
            }
        },

        isVillageScreenActive() {
            const el = document.getElementById('village-screen');
            return el && el.classList.contains('active');
        },

        applyDailyUpkeep() {
            if (!Array.isArray(this.player.team) || this.player.team.length === 0) return;
            let totalCost = 0;
            for (const npcId of this.player.team) {
                const npc = this.recruitableNPCs[npcId];
                if (npc) totalCost += npc.costPerDay;
            }

            if (totalCost <= 0) return;
            if (this.player.ryo >= totalCost) {
                this.player.ryo -= totalCost;
                return;
            }

            // Si no pag√°s, se van
            alert('üí∏ No tienes Ryo para pagar al equipo. Los compa√±eros se han ido.');
            this.player.team = [];
        },

        checkRecurringEvents() {
            if (!this.player) return;
            // Solo mostramos popups en el inicio de cada ma√±ana para no spamear
            if (this.player.timeOfDay !== 0) return;

            const todayEvents = this.recurringEvents.filter(e => {
                try { return e.when(this.player); } catch { return false; }
            });

            if (todayEvents.length > 0) {
                const names = todayEvents.map(e => `‚Ä¢ ${e.name}`).join('\n');
                alert(`üóìÔ∏è Eventos de hoy:\n${names}`);
            }
        },

        checkRandomDailyEvents() {
            // Mercado negro (aleatorio)
            const chance = 0.07; // 7% al d√≠a
            const isActive = Math.random() < chance;
            this.player.blackMarketToday = isActive;
            if (!isActive) {
                this.player.blackMarketOffer = null;
            }

            // Inicio de mes: invasi√≥n 10%
            if (this.player.day === 1 && this.player.timeOfDay === 0) {
                if (Math.random() < 0.10 && this.player.location === 'konoha') {
                    this.spawnUrgentMission('üèØ Invasi√≥n de la aldea', 3);
                }
            }

            // Maestro visitante (aleatorio)
            if (Math.random() < 0.04 && this.player.location === 'konoha') {
                this.player.visitingMasterToday = true;
            } else {
                this.player.visitingMasterToday = false;
            }
        },

        getBlackMarketOffer() {
            if (!this.player.blackMarketToday) return null;
            const stamp = `${this.player.year}-${this.player.month}-${this.player.day}`;
            if (this.player.blackMarketOffer && this.player.blackMarketOffer.stamp === stamp) {
                return this.player.blackMarketOffer;
            }

            // Elegir un jutsu raro (prioriza master, luego jonin)
            const rarePool = [...(this.academyJutsus.master || []), ...(this.academyJutsus.jonin || [])];
            const available = rarePool.filter(j => !this.player.learnedJutsus?.some(l => l.name === j.name));
            const chosen = (available.length ? available : rarePool)[Math.floor(Math.random() * rarePool.length)];

            const base = Math.floor((chosen.price || 2000) * 1.5);
            const price = this.applyPriceDiscount(base);

            this.player.blackMarketOffer = {
                stamp,
                jutsu: chosen,
                name: chosen.name,
                rank: chosen.rank,
                price
            };

            return this.player.blackMarketOffer;
        },

        buyBlackMarketJutsu() {
            if (!this.player.blackMarketToday) {
                alert('El Mercado Negro no est√° disponible ahora.');
                return;
            }
            if (this.player.location !== 'konoha') {
                alert('Este contacto del Mercado Negro solo est√° en Konoha.');
                return;
            }
            if (this.player.timeOfDay === 3) {
                alert('Es madrugada. No es seguro comerciar ahora.');
                return;
            }

            const offer = this.getBlackMarketOffer();
            if (!offer) return;

            const already = this.player.learnedJutsus?.some(l => l.name === offer.jutsu.name);
            if (already) {
                alert('Ya aprendiste ese jutsu.');
                return;
            }
            if (this.player.ryo < offer.price) {
                alert('No tienes suficiente Ryo para el Mercado Negro.');
                return;
            }

            this.player.ryo -= offer.price;
            this.player.learnedJutsus.push(offer.jutsu);
            this.player.blackMarketToday = false;
            this.player.blackMarketOffer = null;
            alert(`üï∂Ô∏è Compraste y aprendiste: ${offer.jutsu.name}`);
            this.updateVillageUI();
            this.showAcademy('master');
            this.saveGame();
        },

        spawnUrgentMission(title, daysLimit) {
            const turnsLimit = daysLimit * this.turnsPerDay;
            this.player.urgentMission = {
                name: title,
                createdAt: { day: this.player.day, month: this.player.month, year: this.player.year },
                turnsLeft: turnsLimit,
                ryoMultiplier: 2,
                expMultiplier: 1.2
            };
            alert(`üö® MISI√ìN URGENTE: ${title}\nTiempo l√≠mite: ${daysLimit} d√≠as`);
        },

        buildUrgentMissionTemplate() {
            // Plantilla simple (puede evolucionar a varias urgentes distintas)
            // Ajuste por rango del jugador
            const rank = (this.player.rank || 'Genin');
            let enemyType = 'genin';
            let count = 2;
            let baseRyo = 400;
            let baseExp = 120;
            if (rank === 'Chunin') { enemyType = 'chunin'; count = 2; baseRyo = 700; baseExp = 180; }
            else if (rank === 'Jonin') { enemyType = 'jonin'; count = 2; baseRyo = 1200; baseExp = 260; }
            else if (rank === 'ANBU' || rank === 'Kage') { enemyType = 'akatsuki'; count = 1; baseRyo = 1800; baseExp = 320; }

            return {
                name: this.player.urgentMission?.name || 'Misi√≥n urgente',
                rank: 'U',
                description: 'Requiere atenci√≥n inmediata. Recompensa mejorada.',
                enemies: [{ type: enemyType, index: 0, count }],
                ryo: baseRyo,
                exp: baseExp,
                isUrgent: true,
                turns: 2
            };
        },

        startUrgentMission() {
            if (!this.player?.urgentMission) {
                alert('No tienes misiones urgentes activas.');
                return;
            }
            const urgent = this.player.urgentMission;
            const mission = this.buildUrgentMissionTemplate();
            mission.ryo = Math.floor(mission.ryo * (urgent.ryoMultiplier || 2));
            mission.exp = Math.floor(mission.exp * (urgent.expMultiplier || 1.2));
            this.startMission(mission);
        },

        tickUrgentMission(turnsPassed) {
            if (!this.player.urgentMission) return;
            this.player.urgentMission.turnsLeft -= turnsPassed;
            if (this.player.urgentMission.turnsLeft <= 0) {
                alert('‚è≥ Fallaste una misi√≥n urgente. Pierdes reputaci√≥n.');
                this.applyReputationDelta(this.player.location, -10);
                this.player.urgentMission = null;
            }
        },

        applyReputationDelta(locationId, delta) {
            if (!this.player.reputation) this.player.reputation = {};
            const current = this.player.reputation[locationId] || 0;
            this.player.reputation[locationId] = this.clamp(current + delta, 0, 100);
        },

        getReputationTier(locationId) {
            const rep = (this.player.reputation && this.player.reputation[locationId]) || 0;
            if (rep <= 20) return 'Desconocido';
            if (rep <= 50) return 'Conocido';
            if (rep <= 80) return 'Respetado';
            return 'H√©roe';
        },

        getReputationDiscount(locationId) {
            const rep = (this.player.reputation && this.player.reputation[locationId]) || 0;
            if (rep <= 20) return 0;
            if (rep <= 50) return 0.05;
            if (rep <= 80) return 0.10;
            return 0.15;
        },

        isFestivalActive() {
            return this.player.location === 'konoha' && this.player.month === 5 && this.player.day === 15;
        },

        applyPriceDiscount(basePrice) {
            let price = basePrice;
            const repDiscount = this.getReputationDiscount(this.player.location);
            if (this.isFestivalActive()) {
                price = Math.floor(price * 0.5);
            }
            price = Math.floor(price * (1 - repDiscount));
            return Math.max(1, price);
        },

        // -----------------------------
        // HUD Calendario (inyectada)
        // -----------------------------
        ensureWorldHUD() {
            const village = document.getElementById('village-screen');
            if (!village) return;

            let hud = document.getElementById('world-hud');
            if (hud) return;

            hud = document.createElement('div');
            hud.id = 'world-hud';
            hud.className = 'player-info';
            hud.style.marginTop = '15px';
            hud.style.borderColor = 'rgba(52, 152, 219, 0.55)';

            // Insertar luego del primer .player-info (info del jugador)
            const firstInfo = village.querySelector('.player-info');
            if (firstInfo && firstInfo.parentNode) {
                firstInfo.parentNode.insertBefore(hud, firstInfo.nextSibling);
            } else {
                village.insertBefore(hud, village.firstChild);
            }

            hud.innerHTML = `
                <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
                    <div>
                        <div style="color:#ff8c00; font-weight:bold;">üóìÔ∏è <span id="hud-date"></span></div>
                        <div style="margin-top:4px;">
                            <span style="background: rgba(255,140,0,0.18); border:1px solid rgba(255,140,0,0.35); padding:4px 10px; border-radius:999px; font-weight:bold; display:inline-block;">
                                <span id="hud-time"></span>
                            </span>
                            <span style="margin-left:8px; color: rgba(240,240,240,0.85);">üåø <span id="hud-season"></span></span>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div>üìç Ubicaci√≥n: <b id="hud-location"></b></div>
                        <div style="margin-top:4px;">üå°Ô∏è Clima: <b id="hud-weather"></b></div>
                    </div>
                </div>
                <div style="margin-top:12px; display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:10px;">
                    <div class="info-item">üòì Fatiga: <b id="hud-fatigue"></b></div>
                    <div class="info-item">üë• Equipo: <b id="hud-team"></b></div>
                    <div class="info-item">üèÖ Reputaci√≥n: <b id="hud-rep"></b></div>
                </div>
                <div style="margin-top:12px;">
                    <div style="color:#ff8c00; font-weight:bold;">PR√ìXIMOS EVENTOS:</div>
                    <div id="hud-events" style="margin-top:6px; font-size:0.95em;"></div>
                </div>
                <div style="margin-top:12px; text-align:center;">
                    <button class="btn btn-small" onclick="game.restInVillage()">Descansar (+1 turno)</button>
                    <button class="btn btn-small btn-secondary" onclick="game.sleepInVillage()">Dormir (+2 turnos)</button>
                    <button class="btn btn-small" onclick="game.toggleTravelPanel()">Viajar</button>
                    <button class="btn btn-small" onclick="game.activateVillageTab('missions')">Misi√≥n</button>
                    <button class="btn btn-small" onclick="game.activateVillageTab('training')">Entrenar</button>
                    <button class="btn btn-small" onclick="game.activateVillageTab('shop')">Tienda</button>
                </div>
                <div id="travel-panel" style="display:none; margin-top:12px; padding-top:12px; border-top:1px solid rgba(74,85,131,0.45);">
                    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
                        <div style="color:#ff8c00; font-weight:bold;">üß≠ Viaje</div>
                        <div style="font-size:0.9em; color: rgba(240,240,240,0.78);">Cada d√≠a consume 10% Chakra y puede haber encuentros</div>
                    </div>
                    <div style="margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <div style="margin-bottom:6px;">Destino</div>
                            <select id="travel-destination" style="width:100%; padding:10px; border-radius:8px; background: rgba(0,0,0,0.4); color:#fff; border:1px solid rgba(74,85,131,0.6);"></select>
                        </div>
                        <div>
                            <div style="margin-bottom:6px;">Opciones</div>
                            <label style="display:flex; gap:8px; align-items:center; background: rgba(0,0,0,0.25); padding:10px; border-radius:8px; border:1px solid rgba(74,85,131,0.4);">
                                <input type="checkbox" id="travel-group" />
                                Viajar en grupo (+1 d√≠a, m√°s seguro)
                            </label>
                        </div>
                    </div>
                    <div style="margin-top:10px; text-align:center;">
                        <button class="btn btn-small" onclick="game.startTravelFromHUD()">Iniciar viaje</button>
                        <button class="btn btn-small btn-secondary" onclick="game.toggleRecruitPanel()">Reclutar equipo</button>
                    </div>
                    <div id="recruit-panel" style="display:none; margin-top:10px;"></div>
                </div>
            `;

            this.populateTravelDestinations();
            this.renderRecruitPanel();
        },

        updateWorldHUD() {
            const hud = document.getElementById('world-hud');
            if (!hud || !this.player) return;

            const loc = this.locations[this.player.location] || { name: this.player.location, icon: 'üìç' };
            const dateText = `${this.monthNames[this.player.month - 1]}, D√≠a ${this.player.day}, A√±o ${this.player.year} ¬∑ ${this.weekdayNames[this.player.weekday]}`;
            document.getElementById('hud-date').textContent = dateText;
            document.getElementById('hud-time').textContent = `${this.getTimeOfDayLabel()}`;
            document.getElementById('hud-season').textContent = this.getSeasonLabel();
            document.getElementById('hud-location').textContent = `${loc.icon} ${loc.name}`;
            document.getElementById('hud-weather').textContent = this.getWeatherLabel();
            document.getElementById('hud-fatigue').textContent = `${this.player.fatigue}%`;

            const teamNames = (this.player.team || []).map(id => this.recruitableNPCs[id]?.name || id);
            document.getElementById('hud-team').textContent = teamNames.length ? teamNames.join(', ') : 'Solo';

            const rep = (this.player.reputation && this.player.reputation[this.player.location]) || 0;
            document.getElementById('hud-rep').textContent = `${rep} (${this.getReputationTier(this.player.location)})`;

            const events = this.getUpcomingEvents(7);
            const eventsDiv = document.getElementById('hud-events');
            if (events.length === 0) {
                eventsDiv.textContent = '‚Ä¢ Ninguno';
            } else {
                eventsDiv.innerHTML = events.map(e => `‚Ä¢ ${e}`).join('<br>');
            }

            this.populateTravelDestinations();
            this.renderRecruitPanel();
        },

        getUpcomingEvents(daysAhead) {
            const events = [];

            // Copia ligera del calendario
            let d = this.player.day;
            let m = this.player.month;
            let y = this.player.year;
            let loc = this.player.location;

            for (let i = 0; i <= daysAhead; i++) {
                const temp = { ...this.player, day: d, month: m, year: y, location: loc };

                // Festival
                if (temp.location === 'konoha' && temp.month === 5 && temp.day === 15) {
                    const inDays = i;
                    events.push(`Festival de Konoha (${inDays} d√≠a${inDays === 1 ? '' : 's'})`);
                }

                // Luna llena
                if (temp.day === 15) {
                    const inDays = i;
                    events.push(`Luna Llena (${inDays} d√≠a${inDays === 1 ? '' : 's'})`);
                }

                // Examen
                if (temp.location === 'konoha' && temp.day === 1 && (temp.month === 1 || temp.month === 7)) {
                    const inDays = i;
                    events.push(`Examen Chunin (${inDays} d√≠a${inDays === 1 ? '' : 's'})`);
                }

                // Torneo
                if (temp.location === 'konoha' && temp.day === 30) {
                    const inDays = i;
                    events.push(`Torneo de la Aldea (${inDays} d√≠a${inDays === 1 ? '' : 's'})`);
                }

                // avanzar 1 d√≠a
                d += 1;
                if (d > this.daysPerMonth) {
                    d = 1;
                    m += 1;
                    if (m > this.monthsPerYear) {
                        m = 1;
                        y += 1;
                    }
                }
            }

            // Urgente
            if (this.player.urgentMission) {
                const turnsLeft = this.player.urgentMission.turnsLeft;
                const daysLeft = Math.ceil(turnsLeft / this.turnsPerDay);
                events.unshift(`üö® Urgente: ${this.player.urgentMission.name} (${daysLeft} d√≠as)`);
            }

            // Mercado negro
            if (this.player.blackMarketToday) {
                events.unshift('üï∂Ô∏è Mercado Negro (hoy)');
            }

            // Maestro visitante
            if (this.player.visitingMasterToday) {
                events.unshift('üë§ Maestro visitante (hoy: 1 jutsu gratis)');
            }

            return events.slice(0, 4);
        },

        activateVillageTab(tabName) {
            // Tabs principales del village (misiones/academia/tienda/entrenamiento/stats)
            const village = document.getElementById('village-screen');
            if (!village) return;

            // Activar contenido
            village.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            const activeContent = document.getElementById(tabName + '-tab');
            if (activeContent) activeContent.classList.add('active');

            // Activar bot√≥n por onclick
            village.querySelectorAll('.tabs .tab-btn').forEach(btn => {
                const oc = btn.getAttribute('onclick') || '';
                if (oc.includes(`showTab('${tabName}')`)) btn.classList.add('active');
                else if (oc.includes("showTab('")) btn.classList.remove('active');
            });

            if (tabName === 'missions') this.showMissions();
            else if (tabName === 'academy') this.showAcademy('genin');
            else if (tabName === 'shop') this.showShop();
            else if (tabName === 'training') this.showTraining();
            else if (tabName === 'stats') this.showStats();
        },

        toggleTravelPanel() {
            const el = document.getElementById('travel-panel');
            if (!el) return;
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        },

        populateTravelDestinations() {
            const sel = document.getElementById('travel-destination');
            if (!sel) return;
            const current = this.player?.location;
            const opts = Object.entries(this.locations)
                .filter(([id, info]) => id !== current)
                .map(([id, info]) => ({ id, label: `${info.icon} ${info.name}` }));

            const previous = sel.value;
            sel.innerHTML = opts.map(o => `<option value="${o.id}">${o.label}</option>`).join('');
            if (previous && opts.some(o => o.id === previous)) sel.value = previous;
        },

        toggleRecruitPanel() {
            const el = document.getElementById('recruit-panel');
            if (!el) return;
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        },

        renderRecruitPanel() {
            const el = document.getElementById('recruit-panel');
            if (!el || !this.player) return;

            const team = new Set(this.player.team || []);
            const canAdd = team.size < 2;

            const rows = Object.values(this.recruitableNPCs).map(npc => {
                const inTeam = team.has(npc.id);
                const disabled = (!inTeam && !canAdd);
                const btnLabel = inTeam ? 'Quitar' : 'Reclutar';
                const btnClass = inTeam ? 'btn btn-small btn-secondary' : 'btn btn-small';
                const onclick = inTeam
                    ? `game.dismissTeammate('${npc.id}')`
                    : `game.recruitTeammate('${npc.id}')`;
                const safe = disabled ? 'disabled' : '';

                return `
                    <div class="shop-item" style="margin:8px 0;">
                        <h4>üë• ${npc.name}</h4>
                        <p>üí∞ ${npc.costPerDay} Ryo/d√≠a</p>
                        <p style="font-size:0.9em;">${this.describeNpcPerk(npc)}</p>
                        <button class="${btnClass}" onclick="${onclick}" ${safe}>${btnLabel}</button>
                    </div>
                `;
            });

            el.innerHTML = `
                <div style="color:#ff8c00; font-weight:bold; margin-bottom:8px;">Equipo (m√°x. 2 compa√±eros)</div>
                ${rows.join('')}
            `;
        },

        describeNpcPerk(npc) {
            switch (npc.perk) {
                case 'mission_ryo': return `+${Math.round(npc.perkValue * 100)}% Ryo en misiones`;
                case 'mission_exp': return `+${Math.round(npc.perkValue * 100)}% EXP en misiones`;
                case 'combat_damage': return `+${npc.perkValue} da√±o f√≠sico (auto)`;
                case 'team_evasion': return `+${Math.round(npc.perkValue * 100)}% evasi√≥n del equipo`;
                case 'between_heal': return `Cura entre combates (+${Math.round(npc.perkValue * 100)}% HP)`;
                default: return 'Apoyo';
            }
        },

        recruitTeammate(npcId) {
            if (!this.player) return;
            const npc = this.recruitableNPCs[npcId];
            if (!npc) return;
            this.player.team = Array.isArray(this.player.team) ? this.player.team : [];
            if (this.player.team.includes(npcId)) return;
            if (this.player.team.length >= 2) {
                alert('Tu equipo ya est√° completo (m√°x. 2 compa√±eros).');
                return;
            }
            this.player.team.push(npcId);
            this.player.friendship[npcId] = this.player.friendship[npcId] ?? 0;
            alert(`üë• ${npc.name} se uni√≥ a tu equipo.`);
            this.updateVillageUI();
            this.saveGame();
        },

        dismissTeammate(npcId) {
            if (!this.player || !Array.isArray(this.player.team)) return;
            this.player.team = this.player.team.filter(id => id !== npcId);
            alert('Compa√±ero removido del equipo.');
            this.updateVillageUI();
            this.saveGame();
        },

        startTravelFromHUD() {
            const sel = document.getElementById('travel-destination');
            if (!sel) return;
            const destination = sel.value;
            const groupTravel = document.getElementById('travel-group')?.checked || false;
            this.travel(destination, { groupTravel });
        },

        travel(destination, opts = {}) {
            if (!this.player) return;
            if (!destination || !this.locations[destination]) {
                alert('Destino inv√°lido.');
                return;
            }
            if (destination === this.player.location) {
                alert('Ya est√°s en ese lugar.');
                return;
            }

            // No viajar si est√°s en combate
            if (document.getElementById('combat-screen')?.classList.contains('active')) {
                alert('No puedes viajar en medio de un combate.');
                return;
            }

            const groupTravel = !!opts.groupTravel;
            const travelDays = this.getTravelDays(this.player.location, destination, { groupTravel });

            this.player.travelState = {
                from: this.player.location,
                to: destination,
                remainingDays: travelDays,
                groupTravel,
                startedAt: { day: this.player.day, month: this.player.month, year: this.player.year }
            };

            const fromLoc = this.locations[this.player.location];
            const toLoc = this.locations[destination];
            alert(`üß≠ Viaje iniciado: ${fromLoc.icon} ${fromLoc.name} ‚Üí ${toLoc.icon} ${toLoc.name}\nDuraci√≥n estimada: ${travelDays} d√≠a(s)`);

            this.processNextTravelDay();
        },

        getTravelDays(fromId, toId, opts = {}) {
            const groupTravel = !!opts.groupTravel;

            const getKonohaDistance = (id) => {
                if (id === 'konoha') return 0;
                return this.locations[id]?.daysFromKonoha ?? 4;
            };

            let baseDays = 0;
            if (fromId === 'konoha' || toId === 'konoha') {
                const other = fromId === 'konoha' ? toId : fromId;
                baseDays = Math.max(1, getKonohaDistance(other));
            } else {
                // simplificaci√≥n: via Konoha (hub)
                baseDays = Math.max(2, getKonohaDistance(fromId) + getKonohaDistance(toId));
            }

            // Estaci√≥n y clima
            if (this.player.season === 'invierno') baseDays += 1;
            if (this.player.weather === 'lluvia') baseDays += 1;
            if (this.player.weather === 'tormenta') baseDays += 2;
            if (this.player.weather === 'nieve') baseDays += 1;

            // Viajar en grupo (m√°s seguro, pero m√°s lento)
            if (groupTravel) baseDays += 1;

            // Equipo acelera (-1 d√≠a)
            const team = Array.isArray(this.player.team) ? this.player.team : [];
            if (team.length > 0) baseDays = Math.max(1, baseDays - 1);

            return baseDays;
        },

        getTravelEncounterChance(groupTravel) {
            let chance = 0.25;
            if (this.player.weather === 'tormenta' || this.player.weather === 'nieve') chance += 0.10;
            if (this.player.weather === 'lluvia') chance += 0.05;

            const team = Array.isArray(this.player.team) ? this.player.team : [];
            if (team.length > 0) chance -= 0.05;
            if (groupTravel) chance -= 0.08;

            return this.clamp(chance, 0.05, 0.60);
        },

        processNextTravelDay() {
            if (!this.player?.travelState) return;

            const state = this.player.travelState;
            if (state.remainingDays <= 0) {
                this.finishTravelArrival();
                return;
            }

            state.remainingDays -= 1;

            // Costos del d√≠a
            const chakraCost = Math.max(1, Math.floor(this.player.maxChakra * 0.10));
            this.player.chakra = Math.max(0, this.player.chakra - chakraCost);
            this.addFatigue(5);
            this.advanceTurns(this.turnsPerDay, 'travel');

            // Encuentro aleatorio
            const encounterChance = this.getTravelEncounterChance(state.groupTravel);
            const hasEncounter = Math.random() < encounterChance;

            if (hasEncounter) {
                const enemy = this.generateTravelEncounterEnemy(state.to);
                this.startTravelEncounter(enemy);
                return;
            }

            // Continuar viaje
            if (state.remainingDays <= 0) {
                this.finishTravelArrival();
                return;
            }

            // Feedback m√≠nimo
            this.updateVillageUI();
            setTimeout(() => this.processNextTravelDay(), 300);
        },

        generateTravelEncounterEnemy(destinationId) {
            const dist = this.locations[destinationId]?.daysFromKonoha ?? 4;
            let poolKey = 'genin';
            if (dist <= 3) poolKey = 'genin';
            else if (dist <= 5) poolKey = 'chunin';
            else if (dist <= 7) poolKey = 'jonin';
            else poolKey = 'akatsuki';

            const pool = this.enemies[poolKey] || this.enemies.genin;
            const tpl = pool[Math.floor(Math.random() * pool.length)];
            const enemy = { ...tpl, maxHp: tpl.hp, maxChakra: tpl.chakra };

            // Escala suave por distancia
            const scale = 1 + Math.min(0.35, dist * 0.03);
            enemy.hp = Math.floor(enemy.hp * scale);
            enemy.maxHp = enemy.hp;
            enemy.attack = Math.floor(enemy.attack * scale);
            enemy.defense = Math.floor(enemy.defense * scale);
            return enemy;
        },

        startTravelEncounter(enemy) {
            this.currentMission = {
                name: 'Encuentro en el camino',
                rank: 'E',
                description: 'Un enemigo intercepta tu ruta.',
                enemies: [],
                ryo: 60,
                exp: 30,
                isTravelEncounter: true
            };
            this.currentEnemy = enemy;
            this.enemyQueue = [];
            this.totalWaves = 1;
            this.currentWave = 1;
            this.startCombat();
        },

        finishTravelArrival() {
            const state = this.player.travelState;
            const toId = state.to;
            const toLoc = this.locations[toId];
            this.player.location = toId;
            this.player.travelState = null;
            alert(`üìç Has llegado a ${toLoc.icon} ${toLoc.name}.`);
            this.updateVillageUI();
            this.saveGame();
        },

        sleepInVillage() {
            if (!this.player) return;
            // +2 turnos, recupera todo y reduce fatiga 50%
            this.player.hp = this.player.maxHp;
            this.player.chakra = this.player.maxChakra;
            this.player.fatigue = Math.floor(this.player.fatigue * 0.5);
            this.advanceTurns(2, 'sleep');
            alert('üò¥ Dormiste 12 horas. HP/Chakra restaurados y fatiga reducida.');
        },

        showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'missions') this.showMissions();
            else if (tabName === 'academy') this.showAcademy('genin');
            else if (tabName === 'shop') this.showShop();
            else if (tabName === 'training') this.showTraining();
            else if (tabName === 'stats') this.showStats();
        },

        showMissions() {
            const missionList = document.getElementById('mission-list');
            missionList.innerHTML = '';

            if (this.player.urgentMission) {
                const turnsLeft = this.player.urgentMission.turnsLeft;
                const daysLeft = Math.ceil(turnsLeft / this.turnsPerDay);
                const urgentCard = document.createElement('div');
                urgentCard.className = 'mission-card';
                urgentCard.style.borderLeftColor = '#c0392b';
                urgentCard.style.background = 'rgba(192, 57, 43, 0.18)';
                urgentCard.onclick = () => this.startUrgentMission();
                urgentCard.innerHTML = `
                    <h4>üö® ${this.player.urgentMission.name} [URGENTE]</h4>
                    <p>Tiempo l√≠mite: ${daysLeft} d√≠a(s) ¬∑ Recompensa x${this.player.urgentMission.ryoMultiplier || 2}</p>
                    <p style="color:#ffd700; margin-top:8px;">Si fallas: -Reputaci√≥n</p>
                `;
                missionList.appendChild(urgentCard);
            }
            
            let availableMissions = [];
            
            if (this.player.rank === 'Genin') {
                availableMissions = this.missions.genin;
            } else if (this.player.rank === 'Chunin') {
                availableMissions = this.missions.chunin;
            } else if (this.player.rank === 'Jonin') {
                availableMissions = this.missions.jonin;
            } else if (this.player.rank === 'ANBU' || this.player.rank === 'Kage') {
                availableMissions = this.missions.kage;
            }
            
            availableMissions.forEach(mission => {
                const card = document.createElement('div');
                card.className = 'mission-card';
                card.onclick = () => this.startMission(mission);

                const rank = (mission.rank || '').toUpperCase();
                const turnCostByRank = { D: 1, C: 2, B: 3, A: 4, S: 4 };
                const turns = mission.turns ?? (turnCostByRank[rank] ?? 2);

                const team = this.getTeamBonuses();
                const nightRyoMult = this.player.timeOfDay === 2 ? 1.2 : 1;
                const estRyo = Math.floor(mission.ryo * (team.missionRyoMult || 1) * nightRyoMult);
                const estExp = Math.floor(mission.exp * (team.missionExpMult || 1));
                
                card.innerHTML = `
                    <h4>üìú ${mission.name} [Rango ${mission.rank}]</h4>
                    <p>${mission.description}</p>
                    <p style="color: #ffd700; margin-top: 8px;">Recompensa: ${estRyo} Ryo | ${estExp} EXP</p>
                    <p style="opacity: 0.85; margin-top: 6px;">‚è±Ô∏è Tiempo: ${turns} turno(s)</p>
                `;
                
                missionList.appendChild(card);
            });
        },

        showAcademy(rank) {
            const jutsuList = document.getElementById('academy-jutsu-list');
            jutsuList.innerHTML = '';

            if (this.player.location !== 'konoha') {
                jutsuList.innerHTML = '<div class="story-text">üìç La Academia Ninja solo est√° disponible en Konoha.</div>';
                return;
            }
            if (this.player.timeOfDay === 3) {
                jutsuList.innerHTML = '<div class="story-text">üåô Es madrugada. La Academia est√° cerrada.</div>';
                return;
            }
            
            const jutsus = this.academyJutsus[rank] || [];
            
            jutsus.forEach(jutsu => {
                const isLearned = this.player.learnedJutsus.some(j => j.name === jutsu.name);
                const finalPrice = this.applyPriceDiscount(jutsu.price);
                
                const card = document.createElement('div');
                card.className = isLearned ? 'learned-jutsu' : 'jutsu-card';
                
                if (!isLearned) {
                    card.onclick = () => this.learnJutsu(jutsu);
                }
                
                card.innerHTML = `
                    <h4>${isLearned ? '‚úÖ' : 'üìñ'} ${jutsu.name} [${jutsu.rank}]</h4>
                    <p>${jutsu.description}</p>
                    <p style="margin-top: 5px;">üíô ${jutsu.chakra} Chakra | ${jutsu.damage > 0 ? `‚öîÔ∏è ${jutsu.damage} da√±o` : 'üåÄ Efecto especial'}</p>
                    <p style="color: ${isLearned ? '#2ecc71' : '#ffd700'}; margin-top: 8px;">
                        ${isLearned ? 'APRENDIDO' : `üí∞ ${finalPrice} Ryo`}
                    </p>
                `;
                
                jutsuList.appendChild(card);
            });

            if (this.player.blackMarketToday) {
                const offer = this.getBlackMarketOffer();
                const card = document.createElement('div');
                card.className = 'mission-card';
                card.style.borderLeftColor = '#95a5a6';
                card.onclick = () => this.buyBlackMarketJutsu();
                card.innerHTML = `
                    <h4>üï∂Ô∏è Mercado Negro: ${offer.name} [${offer.rank}]</h4>
                    <p>Oferta del d√≠a (jutsu raro). Precio especial.</p>
                    <p style="color:#ffd700; margin-top: 8px;">üí∞ ${offer.price} Ryo</p>
                `;
                jutsuList.appendChild(card);
            }
        },

        showJutsuRank(rank) {
            this.showAcademy(rank);
        },

        learnJutsu(jutsu) {
            if (this.player.location !== 'konoha') {
                alert('La Academia solo est√° disponible en Konoha.');
                return;
            }
            if (this.player.timeOfDay === 3) {
                alert('Es madrugada. La Academia est√° cerrada.');
                return;
            }
            
            const alreadyLearned = this.player.learnedJutsus.some(j => j.name === jutsu.name);
            if (alreadyLearned) {
                alert('Ya aprendiste este jutsu!');
                return;
            }

            let finalPrice = this.applyPriceDiscount(jutsu.price);
            if (this.player.visitingMasterToday) {
                finalPrice = 0;
                this.player.visitingMasterToday = false;
                alert('üë§ Maestro visitante: aprend√©s este jutsu gratis (una vez).');
            }

            if (this.player.ryo < finalPrice) {
                alert('¬°No tienes suficiente Ryo!');
                return;
            }
            
            this.player.ryo -= finalPrice;
            this.player.learnedJutsus.push(jutsu);
            
            alert(`¬°Has aprendido ${jutsu.name}!`);
            this.updateVillageUI();

            // Refrescar la academia en el rango activo
            const activeRankBtn = document.querySelector('#academy-tab .tabs .tab-btn.active');
            const label = (activeRankBtn?.textContent || 'Genin').toLowerCase().trim();
            const map = { genin: 'genin', chunin: 'chunin', jonin: 'jonin', maestros: 'master' };
            this.showAcademy(map[label] || 'genin');
            this.saveGame();
        },

        showShop() {
            const shopList = document.getElementById('shop-list');
            if (this.player.location !== 'konoha') {
                shopList.innerHTML = '<div class="story-text">üìç La Tienda de la Aldea solo est√° disponible en Konoha.</div>';
                return;
            }
            if (this.player.timeOfDay === 3) {
                shopList.innerHTML = '<div class="story-text">üåô Es madrugada. La tienda est√° cerrada.</div>';
                return;
            }

            const festivalNote = this.isFestivalActive() ? ' (üéâ Festival: -50%)' : '';
            shopList.innerHTML = `<h4 style="grid-column: 1/-1; color: #ff8c00;">Consumibles${festivalNote}</h4>`;
            
            this.shopItems.consumables.forEach(item => {
                const card = this.createShopCard(item);
                shopList.appendChild(card);
            });
            
            shopList.innerHTML += '<h4 style="grid-column: 1/-1; color: #ff8c00; margin-top: 20px;">Armas</h4>';
            this.shopItems.weapons.forEach(item => {
                const card = this.createShopCard(item);
                shopList.appendChild(card);
            });
            
            shopList.innerHTML += '<h4 style="grid-column: 1/-1; color: #ff8c00; margin-top: 20px;">Armaduras</h4>';
            this.shopItems.armor.forEach(item => {
                const card = this.createShopCard(item);
                shopList.appendChild(card);
            });
        },

        createShopCard(item) {
            const card = document.createElement('div');
            card.className = 'shop-item';

            const finalPrice = this.applyPriceDiscount(item.price);
            const priceHtml = finalPrice < item.price
                ? `üí∞ ${finalPrice} Ryo <span style="opacity:0.75; text-decoration:line-through; margin-left:6px;">${item.price}</span>`
                : `üí∞ ${item.price} Ryo`;
            
            card.innerHTML = `
                <h4>${item.name}</h4>
                <p>${item.description}</p>
                <p class="price">${priceHtml}</p>
                <button class="btn btn-small" onclick='game.buyItem(${JSON.stringify(item).replace(/'/g, "\\'")})'>Comprar</button>
            `;
            
            return card;
        },

        buyItem(item) {
            if (this.player.location !== 'konoha') {
                alert('La tienda solo est√° disponible en Konoha.');
                return;
            }
            if (this.player.timeOfDay === 3) {
                alert('Es madrugada. La tienda est√° cerrada.');
                return;
            }

            const finalPrice = this.applyPriceDiscount(item.price);
            if (this.player.ryo < finalPrice) {
                alert('¬°No tienes suficiente Ryo!');
                return;
            }
            
            this.player.ryo -= finalPrice;
            
            if (item.effect.hp || item.effect.chakra || item.effect.buff) {
                this.player.inventory.push({ name: item.name, effect: item.effect });
                alert(`¬°Compraste ${item.name}! Ahora est√° en tu inventario.`);
            } else {
                if (item.effect.taijutsu) this.player.taijutsu += item.effect.taijutsu;
                if (item.effect.maxHp) {
                    this.player.maxHp += item.effect.maxHp;
                    this.player.hp += item.effect.maxHp;
                }
                alert(`¬°Compraste ${item.name}! Tus stats han mejorado.`);
            }
            
            this.updateVillageUI();
            this.saveGame();
        },

        showTraining() {
            const trainingList = document.getElementById('training-list');
            if (this.player.location !== 'konoha') {
                trainingList.innerHTML = '<div class="story-text">üìç El Centro de Entrenamiento solo est√° disponible en Konoha.</div>';
                return;
            }
            if (this.player.timeOfDay === 3) {
                trainingList.innerHTML = '<div class="story-text">üåô Es madrugada. El centro de entrenamiento est√° cerrado.</div>';
                return;
            }

            trainingList.innerHTML = '';
            
            this.training.forEach(item => {
                const card = document.createElement('div');
                card.className = 'shop-item';

                const finalPrice = this.applyPriceDiscount(item.price);
                const priceHtml = finalPrice < item.price
                    ? `üí∞ ${finalPrice} Ryo <span style="opacity:0.75; text-decoration:line-through; margin-left:6px;">${item.price}</span>`
                    : `üí∞ ${item.price} Ryo`;
                
                card.innerHTML = `
                    <h4>${item.name}</h4>
                    <p>${item.description}</p>
                    <p class="price">${priceHtml}</p>
                    <button class="btn btn-small" onclick='game.doTraining(${JSON.stringify(item).replace(/'/g, "\\'")})'>Entrenar</button>
                `;
                
                trainingList.appendChild(card);
            });
        },

        doTraining(item) {
            if (this.player.location !== 'konoha') {
                alert('El entrenamiento solo est√° disponible en Konoha.');
                return;
            }
            if (this.player.timeOfDay === 3) {
                alert('Es madrugada. El centro de entrenamiento est√° cerrado.');
                return;
            }

            const finalPrice = this.applyPriceDiscount(item.price);
            if (this.player.ryo < finalPrice) {
                alert('¬°No tienes suficiente Ryo!');
                return;
            }
            
            // +1 turno y fatiga
            this.addFatigue(8);
            this.advanceTurns(1, 'training');

            this.player.ryo -= finalPrice;

            // Efectividad por estaci√≥n
            let eff = 1;
            if (this.player.season === 'primavera') eff = 1.1;
            if (this.player.season === 'invierno') eff = 0.9;
            
            if (item.effect.taijutsu) this.player.taijutsu += Math.max(1, Math.floor(item.effect.taijutsu * eff));
            if (item.effect.ninjutsu) this.player.ninjutsu += Math.max(1, Math.floor(item.effect.ninjutsu * eff));
            if (item.effect.genjutsu) this.player.genjutsu += Math.max(1, Math.floor(item.effect.genjutsu * eff));
            if (item.effect.maxChakra) {
                const gain = Math.max(1, Math.floor(item.effect.maxChakra * eff));
                this.player.maxChakra += gain;
                this.player.chakra += gain;
            }
            if (item.effect.maxHp) {
                const gain = Math.max(1, Math.floor(item.effect.maxHp * eff));
                this.player.maxHp += gain;
                this.player.hp += gain;
            }
            
            alert(`¬°Entrenamiento completado! ${item.name}`);
            this.updateVillageUI();
            this.saveGame();
        },

        showStats() {
            const statsDisplay = document.getElementById('stats-display');
            statsDisplay.innerHTML = `
                <div class="player-info">
                    <h3 style="color: #ff8c00;">${this.player.clan} Ninja</h3>
                    <div class="info-grid">
                        <div class="info-item">‚ù§Ô∏è HP: ${Math.floor(this.player.hp)}/${this.player.maxHp}</div>
                        <div class="info-item">üíô Chakra: ${Math.floor(this.player.chakra)}/${this.player.maxChakra}</div>
                        <div class="info-item">üëä Taijutsu: ${this.player.taijutsu}</div>
                        <div class="info-item">üåÄ Ninjutsu: ${this.player.ninjutsu}</div>
                        <div class="info-item">üëÅÔ∏è Genjutsu: ${this.player.genjutsu}</div>
                        <div class="info-item">‚≠ê Nivel: ${this.player.level}</div>
                        <div class="info-item">ü•∑ Rango: ${this.player.rank}</div>
                        <div class="info-item">üí∞ Ryo: ${this.player.ryo}</div>
                        <div class="info-item">üèÜ Combates: ${this.player.combatsWon}</div>
                    </div>
                    <div style="margin-top: 20px;">
                        <h4 style="color: #ff8c00;">üìö Jutsus Aprendidos (${this.player.learnedJutsus.length})</h4>
                        ${this.player.learnedJutsus.length === 0 ? '<p>Ninguno - Ve a la Academia</p>' : 
                            this.player.learnedJutsus.map(jutsu => `<div class="stat">${jutsu.name} [${jutsu.rank}]</div>`).join('')}
                    </div>
                    <div style="margin-top: 20px;">
                        <h4 style="color: #ff8c00;">üéí Inventario (${this.player.inventory.length})</h4>
                        ${this.player.inventory.length === 0 ? '<p>Vac√≠o</p>' : 
                            this.player.inventory.map(item => `<div class="stat">${item.name}</div>`).join('')}
                    </div>
                </div>
            `;
        },

        restInVillage() {
            if (!this.player) return;
            // +1 turno (6 horas)
            this.player.hp = this.player.maxHp;
            this.player.chakra = this.player.maxChakra;
            this.reduceFatigue(15);
            this.advanceTurns(1, 'rest');
            alert('üòå Descansaste 6 horas. HP/Chakra restaurados y fatiga reducida.');
        },

        saveGame() {
            try {
                localStorage.setItem('ninjaRPGSave', JSON.stringify(this.player));
                console.log('Partida guardada');
            } catch(e) {
                console.error('Error guardando:', e);
            }
        },

        loadGame() {
            try {
                const save = localStorage.getItem('ninjaRPGSave');
                if (!save) {
                    alert('No hay partida guardada');
                    return;
                }
                
                this.player = JSON.parse(save);
                this.migratePlayerSave();
                this.showScreen('village-screen');
                this.updateVillageUI();
                this.showMissions();
                alert('¬°Partida cargada!');
            } catch(e) {
                console.error('Error cargando:', e);
                alert('Error al cargar la partida');
            }
        },

        deleteCharacterAndRestart() {
            localStorage.removeItem('ninjaRPGSave');
            location.reload();
        },

        startMission(mission) {
            if (!this.player) return;

            // Fatiga por misi√≥n
            this.addFatigue(15);

            // Clonar misi√≥n para no mutar el cat√°logo
            const clonedMission = {
                ...mission,
                enemies: Array.isArray(mission.enemies) ? mission.enemies.map(g => ({ ...g })) : []
            };

            // Costo de tiempo (turnos) por complejidad
            const rank = (clonedMission.rank || '').toUpperCase();
            const turnCostByRank = { D: 1, C: 2, B: 3, A: 4, S: 4 };
            const turnCost = clonedMission.turns ?? (turnCostByRank[rank] ?? 2);
            this.advanceTurns(turnCost, 'mission');

            // Bonus por misi√≥n nocturna
            const isNight = this.player.timeOfDay === 2;
            const nightRyoMult = isNight ? 1.2 : 1;

            // Bonus por equipo
            const team = this.getTeamBonuses();
            const ryoMult = (team.missionRyoMult || 1) * nightRyoMult;
            const expMult = (team.missionExpMult || 1);

            clonedMission.ryo = Math.floor(clonedMission.ryo * ryoMult);
            clonedMission.exp = Math.floor(clonedMission.exp * expMult);

            this.currentMission = clonedMission;
            this.enemyQueue = [];
            
            // Crear cola de enemigos basado en la misi√≥n
            clonedMission.enemies.forEach(enemyGroup => {
                for (let i = 0; i < enemyGroup.count; i++) {
                    const enemyTemplate = this.enemies[enemyGroup.type][enemyGroup.index];
                    this.enemyQueue.push({ ...enemyTemplate, maxHp: enemyTemplate.hp, maxChakra: enemyTemplate.chakra });
                }
            });
            
            this.totalWaves = this.enemyQueue.length;
            this.currentWave = 1;
            
            // Iniciar con el primer enemigo
            this.currentEnemy = this.enemyQueue.shift();
            this.startCombat();
        },

        startCombat() {
            this.showScreen('combat-screen');
            this.combatLog = [];
            document.getElementById('combat-log').innerHTML = '';
            this.kawairimiUsed = false;
            this.defendActive = false;
            
            document.getElementById('combat-player-name').textContent = this.player.clan + ' Ninja';
            document.getElementById('enemy-name').textContent = this.currentEnemy.name + 
                (this.totalWaves > 1 ? ` (${this.currentWave}/${this.totalWaves})` : '');
            document.getElementById('enemy-stats').textContent = 
                `‚öîÔ∏è Ataque: ${this.currentEnemy.attack} | üõ°Ô∏è Defensa: ${this.currentEnemy.defense} | üéØ Precisi√≥n: +${this.currentEnemy.accuracy}`;
            
            this.updateBar('combat-player-health-bar', this.player.hp, this.player.maxHp, 'HP');
            this.updateBar('combat-player-chakra-bar', this.player.chakra, this.player.maxChakra, 'Chakra');
            this.updateBar('enemy-health-bar', this.currentEnemy.hp, this.currentEnemy.maxHp, 'HP');
            
            if (this.currentWave === 1) {
                if (this.currentMission && this.currentMission.isTravelEncounter) {
                    this.addCombatLog('‚ö†Ô∏è Encuentro durante el viaje.', 'log-special');
                } else {
                    this.addCombatLog(`¬°Misi√≥n iniciada! ${this.totalWaves > 1 ? this.totalWaves + ' enemigos detectados!' : 'Un enemigo aparece!'}`, 'log-special');
                }
            }
            this.addCombatLog(`¬°${this.currentEnemy.name} aparece!`, 'log-attack');
            
            this.combatTurn = 'player';
            this.enableCombatButtons();
        },

        addCombatLog(message, className = '') {
            const log = document.getElementById('combat-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${className}`;
            entry.innerHTML = message;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        },

        enableCombatButtons() {
            document.getElementById('attack-btn').disabled = false;
            document.getElementById('jutsu-menu-btn').disabled = false;
            document.getElementById('genjutsu-btn').disabled = false;
            document.getElementById('defend-btn').disabled = false;
            document.getElementById('kawarimi-btn').disabled = this.kawairimiUsed;
            document.getElementById('item-btn').disabled = false;
        },

        disableCombatButtons() {
            document.getElementById('attack-btn').disabled = true;
            document.getElementById('jutsu-menu-btn').disabled = true;
            document.getElementById('genjutsu-btn').disabled = true;
            document.getElementById('defend-btn').disabled = true;
            document.getElementById('kawarimi-btn').disabled = true;
            document.getElementById('item-btn').disabled = true;
        },

        basicAttack() {
            if (this.combatTurn !== 'player') return;

            if (this.checkFatigueFaint()) return;
            
            this.disableCombatButtons();
            document.getElementById('jutsu-selection').style.display = 'none';
            document.getElementById('combat-inventory').style.display = 'none';

            const stats = this.getEffectiveStats();

            const attackRoll = this.rollDice(20);
            const isCrit = attackRoll === 20 || (this.rollDice(100) <= (this.player.critChance || 0));
            const totalAttack = attackRoll + stats.taijutsu;
            const enemyDefense = 10 + this.currentEnemy.defense;

            this.addCombatLog(`Atacas con Taijutsu: <span class="dice-roll">${attackRoll}</span> + ${stats.taijutsu} = ${totalAttack}`, 'log-attack');

            if (totalAttack >= enemyDefense || isCrit) {
                const damageRoll = this.rollDice(8);
                let damage = Math.max(1, damageRoll + Math.floor(stats.taijutsu / 2) + (stats.combatDamageBonus || 0));
                
                if (isCrit) {
                    damage *= 2;
                    this.addCombatLog('¬°CR√çTICO! Da√±o duplicado', 'log-special');
                }
                
                this.currentEnemy.hp -= damage;
                this.addCombatLog(`¬°Impacto! Infliges ${damage} de da√±o.`, 'log-damage');
                this.updateBar('enemy-health-bar', this.currentEnemy.hp, this.currentEnemy.maxHp, 'HP');
                
                if (this.currentEnemy.hp <= 0) {
                    this.winCombat();
                    return;
                }
            } else {
                this.addCombatLog('¬°Fallaste el ataque!', 'log-miss');
            }

            setTimeout(() => this.enemyTurn(), 1500);
        },

        toggleJutsuMenu() {
            const menu = document.getElementById('jutsu-selection');
            const inventory = document.getElementById('combat-inventory');
            inventory.style.display = 'none';
            
            if (menu.style.display === 'none') {
                menu.style.display = 'block';
                this.loadJutsuList();
            } else {
                menu.style.display = 'none';
            }
        },

        loadJutsuList() {
            const jutsuList = document.getElementById('jutsu-list');
            jutsuList.innerHTML = '';
            
            if (this.player.learnedJutsus.length === 0) {
                jutsuList.innerHTML = '<p>No has aprendido jutsus. Ve a la Academia.</p>';
                return;
            }
            
            this.player.learnedJutsus.forEach(jutsu => {
                const btn = document.createElement('button');
                btn.className = 'jutsu-btn';
                btn.disabled = this.player.chakra < jutsu.chakra;
                btn.onclick = () => this.useJutsu(jutsu);
                
                btn.innerHTML = `
                    <h4>${jutsu.name}</h4>
                    <p style="font-size: 0.85em;">${jutsu.description}</p>
                    <p style="color: #3498db; margin-top: 5px;">üíô ${jutsu.chakra} Chakra</p>
                    ${jutsu.damage > 0 ? `<p style="color: #e74c3c;">‚öîÔ∏è ${jutsu.damage} da√±o</p>` : ''}
                `;
                
                jutsuList.appendChild(btn);
            });
        },

        useJutsu(jutsu) {
            if (this.combatTurn !== 'player') return;
            if (this.checkFatigueFaint()) return;
            if (this.player.chakra < jutsu.chakra) return;

            const stats = this.getEffectiveStats();
            
            this.player.chakra -= jutsu.chakra;
            this.updateBar('combat-player-chakra-bar', this.player.chakra, this.player.maxChakra, 'Chakra');
            
            this.disableCombatButtons();
            document.getElementById('jutsu-selection').style.display = 'none';
            
            this.addCombatLog(`Usas ${jutsu.name}!`, 'log-special');
            
            if (jutsu.damage > 0) {
                const damage = jutsu.damage + Math.floor(stats.ninjutsu / 2);
                this.currentEnemy.hp -= damage;
                this.addCombatLog(`¬°Infliges ${damage} de da√±o!`, 'log-damage');
                this.updateBar('enemy-health-bar', this.currentEnemy.hp, this.currentEnemy.maxHp, 'HP');
                
                if (this.currentEnemy.hp <= 0) {
                    this.winCombat();
                    return;
                }
            }
            
            setTimeout(() => this.enemyTurn(), 1500);
        },

        useGenjutsu() {
            if (this.combatTurn !== 'player') return;

            if (this.checkFatigueFaint()) return;
            
            if (this.player.chakra < 30) {
                alert('No tienes suficiente chakra!');
                return;
            }
            
            this.player.chakra -= 30;
            this.updateBar('combat-player-chakra-bar', this.player.chakra, this.player.maxChakra, 'Chakra');
            
            this.disableCombatButtons();
            document.getElementById('jutsu-selection').style.display = 'none';
            document.getElementById('combat-inventory').style.display = 'none';

            const stats = this.getEffectiveStats();

            const genjutsuRoll = this.rollDice(20) + stats.genjutsu;
            const enemyResist = this.rollDice(20) + (this.currentEnemy.genjutsu || 5);
            
            this.addCombatLog(`Lanzas Genjutsu: <span class="dice-roll">${genjutsuRoll}</span> vs ${enemyResist}`, 'log-special');
            
            if (genjutsuRoll > enemyResist) {
                this.addCombatLog('¬°El enemigo est√° aturdido! Pierde su turno.', 'log-special');
                setTimeout(() => {
                    this.combatTurn = 'player';
                    this.enableCombatButtons();
                }, 1500);
            } else {
                this.addCombatLog('¬°El enemigo resisti√≥ el Genjutsu!', 'log-miss');
                setTimeout(() => this.enemyTurn(), 1500);
            }
        },

        defend() {
            if (this.combatTurn !== 'player') return;

            if (this.checkFatigueFaint()) return;
            
            this.disableCombatButtons();
            document.getElementById('jutsu-selection').style.display = 'none';
            document.getElementById('combat-inventory').style.display = 'none';
            
            this.defendActive = true;
            const chakraRegen = 20 + (this.player.chakraRegen || 0);
            this.player.chakra = Math.min(this.player.chakra + chakraRegen, this.player.maxChakra);
            
            this.addCombatLog(`Te defiendes y recuperas ${chakraRegen} chakra.`, 'log-heal');
            this.updateBar('combat-player-chakra-bar', this.player.chakra, this.player.maxChakra, 'Chakra');
            
            setTimeout(() => this.enemyTurn(), 1500);
        },

        useKawarimi() {
            if (this.kawairimiUsed) {
                alert('Ya usaste Kawarimi en este combate!');
                return;
            }
            
            this.kawairimiUsed = true;
            this.addCombatLog('¬°Preparas Kawarimi! Evitar√°s el pr√≥ximo ataque.', 'log-special');
            document.getElementById('kawarimi-btn').disabled = true;
        },

        showInventoryInCombat() {
            const menu = document.getElementById('combat-inventory');
            const jutsuMenu = document.getElementById('jutsu-selection');
            jutsuMenu.style.display = 'none';
            
            if (menu.style.display === 'none') {
                menu.style.display = 'block';
                this.loadCombatInventory();
            } else {
                menu.style.display = 'none';
            }
        },

        loadCombatInventory() {
            const itemsList = document.getElementById('combat-items-list');
            itemsList.innerHTML = '';
            
            if (this.player.inventory.length === 0) {
                itemsList.innerHTML = '<p>No tienes items.</p>';
                return;
            }
            
            this.player.inventory.forEach((item, index) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-small';
                btn.style.width = '100%';
                btn.style.marginBottom = '5px';
                btn.onclick = () => this.useItemInCombat(index);
                btn.textContent = item.name;
                itemsList.appendChild(btn);
            });
        },

        useItemInCombat(index) {
            const item = this.player.inventory[index];
            
            if (item.effect.hp) {
                this.player.hp = Math.min(this.player.hp + item.effect.hp, this.player.maxHp);
                this.addCombatLog(`Usas ${item.name} y recuperas ${item.effect.hp} HP.`, 'log-heal');
                this.updateBar('combat-player-health-bar', this.player.hp, this.player.maxHp, 'HP');
            }
            
            if (item.effect.chakra) {
                this.player.chakra = Math.min(this.player.chakra + item.effect.chakra, this.player.maxChakra);
                this.addCombatLog(`Recuperas ${item.effect.chakra} Chakra.`, 'log-heal');
                this.updateBar('combat-player-chakra-bar', this.player.chakra, this.player.maxChakra, 'Chakra');
            }

            // Fatiga (algunos consumibles)
            if ((item.name || '').toLowerCase().includes('ramen')) {
                this.reduceFatigue(10);
                this.addCombatLog('üçú Te sientes mejor: -10% fatiga.', 'log-heal');
            }
            
            this.player.inventory.splice(index, 1);
            document.getElementById('combat-inventory').style.display = 'none';
            
            this.disableCombatButtons();
            setTimeout(() => this.enemyTurn(), 1500);
        },

        enemyTurn() {
            this.combatTurn = 'enemy';
            this.addCombatLog(`${this.currentEnemy.name} ataca...`, 'log-attack');

            const attackRoll = this.rollDice(20);
            const totalAttack = attackRoll + this.currentEnemy.attack + (this.currentEnemy.accuracy || 0);
            const stats = this.getEffectiveStats();
            let playerDefense = 10 + Math.floor(stats.taijutsu / 2);
            if (stats.teamEvasionBonus > 0) {
                playerDefense += Math.floor(playerDefense * stats.teamEvasionBonus);
            }
            
            if (this.defendActive) {
                playerDefense += 5;
                this.defendActive = false;
            }

            setTimeout(() => {
                if (this.kawairimiUsed && !this.player.kawairimiActivated) {
                    this.addCombatLog('¬°Usas Kawarimi! Te sustituyes y evitas el ataque.', 'log-special');
                    this.player.kawairimiActivated = true;
                    
                    this.combatTurn = 'player';
                    this.enableCombatButtons();
                    return;
                }
                
                this.addCombatLog(`Enemigo tira: <span class="dice-roll">${attackRoll}</span> + ${this.currentEnemy.attack} + ${this.currentEnemy.accuracy} = ${totalAttack} vs Defensa ${playerDefense}`, 'log-attack');

                if (totalAttack >= playerDefense) {
                    const baseDamage = this.rollDice(8) + this.rollDice(6);
                    const damage = Math.max(1, baseDamage + Math.floor(this.currentEnemy.attack / 1.5));
                    this.player.hp -= damage;
                    this.addCombatLog(`¬°Te golpean duramente! Recibes ${damage} de da√±o.`, 'log-damage');
                    this.updateBar('combat-player-health-bar', this.player.hp, this.player.maxHp, 'HP');

                    if (this.player.hp <= 0) {
                        this.defeat();
                        return;
                    }
                } else {
                    this.addCombatLog('¬°Esquivas el ataque!', 'log-miss');
                }

                this.combatTurn = 'player';
                this.enableCombatButtons();
            }, 1000);
        },

        winCombat() {
            this.addCombatLog(`¬°${this.currentEnemy.name} ha sido derrotado!`, 'log-heal');

            // Fatiga por combate
            this.addFatigue(10);
            
            // Ganar recompensas parciales por cada enemigo
            const expPerEnemy = Math.floor(this.currentMission.exp / this.totalWaves);
            const ryoPerEnemy = Math.floor(this.currentMission.ryo / this.totalWaves);
            
            this.player.exp += expPerEnemy;
            this.player.ryo += ryoPerEnemy;
            this.player.combatsWon++;

            // Cura entre combates (Sakura)
            const stats = this.getEffectiveStats();
            if (stats.betweenCombatHealPct > 0) {
                const heal = Math.max(1, Math.floor(this.player.maxHp * stats.betweenCombatHealPct));
                this.player.hp = Math.min(this.player.maxHp, this.player.hp + heal);
                this.addCombatLog(`üíó Tu equipo te asiste y recuperas ${heal} HP.`, 'log-heal');
                this.updateBar('combat-player-health-bar', this.player.hp, this.player.maxHp, 'HP');
            }
            
            this.addCombatLog(`+${expPerEnemy} EXP | +${ryoPerEnemy} Ryo`, 'log-special');
            
            // Verificar si hay m√°s enemigos
            if (this.enemyQueue.length > 0) {
                this.addCombatLog('¬°El siguiente enemigo se acerca!', 'log-special');
                
                setTimeout(() => {
                    this.currentWave++;
                    this.currentEnemy = this.enemyQueue.shift();
                    this.kawairimiUsed = false; // Reiniciar Kawarimi para nuevo enemigo
                    this.player.kawairimiActivated = false;
                    this.startCombat();
                }, 2000);
                return;
            }

            // Combate durante viaje: reanudar viaje sin pantalla de victoria
            if (this.currentMission && this.currentMission.isTravelEncounter) {
                this.currentMission = null;
                this.currentEnemy = null;
                this.saveGame();

                setTimeout(() => {
                    this.showScreen('village-screen');
                    this.updateVillageUI();
                    if (this.player?.travelState) {
                        this.processNextTravelDay();
                    }
                }, 900);
                return;
            }
            
            // Todos los enemigos derrotados - misi√≥n completa
            let kekkeiExpGain = 0;
            if (this.player.kekkeiGenkai) {
                const fullMoonMult = (this.player.day === 15) ? 1.10 : 1;
                kekkeiExpGain = Math.floor((this.currentMission.exp / 2) * fullMoonMult);
                this.player.kekkeiExp += kekkeiExpGain;
                
                const nextLevel = this.player.kekkeiGenkai.levels[this.player.kekkeiLevel];
                if (nextLevel && this.player.kekkeiExp >= nextLevel.exp) {
                    this.levelUpKekkei();
                }
            }
            
            if (this.player.exp >= this.player.expToNext) {
                this.levelUp();
            }

            // Reputaci√≥n
            if (this.currentMission && this.currentMission.isUrgent) {
                this.applyReputationDelta(this.player.location, 12);
                this.player.urgentMission = null;
            } else {
                this.applyReputationDelta(this.player.location, 5);
            }
            
            let victoryText = `¬°Misi√≥n "${this.currentMission.name}" completada!<br>
                Has derrotado a ${this.totalWaves} enemigo(s).<br><br>
                Total: +${this.currentMission.exp} EXP<br>
                Total: +${this.currentMission.ryo} Ryo`;
            
            document.getElementById('mission-victory-text').innerHTML = victoryText;
            
            const kekkeiExpDiv = document.getElementById('kekkei-exp-gain');
            if (this.player.kekkeiGenkai && kekkeiExpGain > 0) {
                kekkeiExpDiv.innerHTML = `<p style="color: #ffd700;">‚ö° +${kekkeiExpGain} EXP de Kekkei Genkai</p>`;
            } else {
                kekkeiExpDiv.innerHTML = '';
            }
            
            this.saveGame();
            
            setTimeout(() => {
                this.showScreen('mission-victory-screen');
            }, 2000);
        },

        levelUp() {
            this.player.level++;
            this.player.exp = 0;
            this.player.expToNext = Math.floor(this.player.expToNext * 1.5);
            
            this.player.maxHp += 15;
            this.player.hp = this.player.maxHp;
            this.player.maxChakra += 20;
            this.player.chakra = this.player.maxChakra;
            this.player.taijutsu += 2;
            this.player.ninjutsu += 2;
            this.player.genjutsu += 2;
            
            if (this.player.level === 4 && this.player.rank === 'Genin') {
                this.player.rank = 'Chunin';
                alert('¬°PROMOCI√ìN! Ahora eres Chunin. ¬°Nuevas misiones disponibles!');
            } else if (this.player.level === 7 && this.player.rank === 'Chunin') {
                this.player.rank = 'Jonin';
                alert('¬°PROMOCI√ìN! Ahora eres Jonin. ¬°Misiones de alto rango desbloqueadas!');
            } else if (this.player.level === 10 && this.player.rank === 'Jonin') {
                this.player.rank = 'ANBU';
                alert('¬°PROMOCI√ìN! Te has unido a ANBU. ¬°Misiones S-Rank disponibles!');
            } else {
                alert(`¬°NIVEL ${this.player.level}! Todos tus stats han aumentado.`);
            }
        },

        levelUpKekkei() {
            const nextLevel = this.player.kekkeiGenkai.levels[this.player.kekkeiLevel];
            
            if (!nextLevel) return;
            
            this.player.kekkeiLevel++;
            
            // Aplicar bonuses del nuevo nivel
            const newLevelData = this.player.kekkeiGenkai.levels[this.player.kekkeiLevel - 1];
            const prevLevelData = this.player.kekkeiGenkai.levels[this.player.kekkeiLevel - 2];
            
            // Calcular diferencia de bonuses
            if (newLevelData.bonus.all) {
                const diff = newLevelData.bonus.all - (prevLevelData?.bonus.all || 0);
                this.player.taijutsu += diff;
                this.player.ninjutsu += diff;
                this.player.genjutsu += diff;
            }
            
            if (newLevelData.bonus.taijutsu) {
                const diff = newLevelData.bonus.taijutsu - (prevLevelData?.bonus.taijutsu || 0);
                this.player.taijutsu += diff;
            }
            if (newLevelData.bonus.ninjutsu) {
                const diff = newLevelData.bonus.ninjutsu - (prevLevelData?.bonus.ninjutsu || 0);
                this.player.ninjutsu += diff;
            }
            if (newLevelData.bonus.genjutsu) {
                const diff = newLevelData.bonus.genjutsu - (prevLevelData?.bonus.genjutsu || 0);
                this.player.genjutsu += diff;
            }
            
            this.player.critChance = newLevelData.bonus.critChance || 0;
            this.player.chakraRegen = newLevelData.bonus.chakraRegen || 0;
            
            alert(`üåü ¬°${this.player.kekkeiGenkai.name} ha evolucionado!\n\nNuevo nivel: ${newLevelData.name}\n\n¬°Tus poderes han aumentado!`);
        },

        returnToVillage() {
            this.showScreen('village-screen');
            this.updateVillageUI();
            this.showMissions();
        },

        defeat() {
            this.showScreen('defeat-screen');
        }
    };

    // Check if there's a saved game on load
    window.onload = function() {
        const hasSave = localStorage.getItem('ninjaRPGSave');
        if (!hasSave) {
            document.getElementById('load-btn').style.display = 'none';
        }
    };
</script>
```

</body>
</html>